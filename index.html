<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoNotify BG ‚Äî –°–µ—Ä–≤–∏–∑–Ω–∞ –∫–Ω–∏–∂–∫–∞ (Calm Pastel)</title>
  <meta name="theme-color" content="#f3f6ff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <!-- –ø—Ä–∏—è—Ç–µ–ª—Å–∫–∏, —á–µ—Ç–∏–º —à—Ä–∏—Ñ—Ç -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* –ü–∞–ª–∏—Ç—Ä–∞ ‚Äî —Å–ø–æ–∫–æ–π–Ω–∏ –ø–∞—Å—Ç–µ–ª–∏ */
      --bg:#f3f6ff;
      --text:#1b2a38;
      --muted:#5d6b7a;

      --card: rgba(255,255,255,.85);
      --border:#e3e9fb;
      --shadow: 0 10px 30px rgba(32,58,92,.10);

      --accent:#5ba7ff;     /* –±—É—Ç–æ–Ω–∏/–∞–∫—Ü–µ–Ω—Ç–∏ */
      --accent-hover:#3f90f3;

      --ok:#28c76f;         /* —Å—Ç–∞—Ç—É—Å–∏ */
      --warn:#f9a826;
      --bad:#ff6b6b;

      --r:14px; --pad:12px; --gap:10px;
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family:"Nunito", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, #edf3ff 0%, transparent 60%),
        radial-gradient(1000px 600px at 90% 110%, #f7f0ff 0%, transparent 55%),
        linear-gradient(180deg, #f7fbff 0%, #f3f6ff 100%);
    }
    /* —Å–Ω–∏–º–∫–∞ + –ë–ï–õ –≤–æ–∞–ª (–∏–∑—Å–≤–µ—Ç–ª—è–≤–∞–Ω–µ) */
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:url('./bg-portrait-1080x1920.webp') center/cover no-repeat;
      filter: saturate(.7) contrast(.9);
    }
    @media (min-aspect-ratio:16/10){
      body::before{ background-image:url('./bg-landscape-1920x1080.webp'); }
    }
    body::after{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1000px 600px at 90% 110%, rgba(255,255,255,.55), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.55));
      mix-blend-mode: lighten;
    }

    /* –õ–µ–π–∞—É—Ç */
    .app{max-width:1180px; margin:0 auto; padding:18px}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .brand{font-weight:700}
    .nav{display:flex; gap:8px; flex-wrap:wrap}

    .btn{
      padding:10px 14px; border-radius:999px;
      background: var(--accent); border:1px solid #cfe0ff; color:white; font-weight:700;
      box-shadow: 0 6px 18px rgba(91,167,255,.25); cursor:pointer
    }
    .btn:hover{ background:var(--accent-hover) }
    .btn.secondary{
      background: white; color:var(--text); border:1px solid var(--border);
      box-shadow: 0 6px 18px rgba(20,40,80,.06);
    }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--r);
      padding:var(--pad); margin-bottom:12px; box-shadow:var(--shadow); backdrop-filter: blur(4px);
    }

    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:var(--gap)}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:#ffffff; color:var(--text); font-size:14px;
      box-shadow:0 1px 0 rgba(10,20,40,.02) inset;
    }
    input:focus,select:focus,textarea:focus{outline:none; border-color:#b9ccff; box-shadow:0 0 0 3px rgba(185,204,255,.35)}

    /* –¢–∞–±–ª–æ ‚Äì —Ä–µ—à–µ—Ç–∫–∞ + –∫–∞—Ä—Ç–∏ */
    #todoList{ display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:12px; }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; border:1px solid var(--border); border-radius:16px; background:#ffffffc4;
      box-shadow: var(--shadow);
    }
    .item-title{font-weight:700}
    .item-sub{font-size:12px; color:var(--muted)}
    .badge{
      min-width:98px; text-align:center; padding:8px 10px; border-radius:10px; font-weight:700;
      background:#eef5ff; border:1px solid #d7e6ff; color:#2d4c7a;
    }
    .ok   { color:var(--ok) }
    .warn { color:var(--warn) }
    .bad  { color:var(--bad) }

    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{padding:3px 10px; border-radius:999px; border:1px solid var(--border); font-size:12px; background:#fff}
    .sep{height:1px; background:var(--border); opacity:.8; margin:8px 0}
    .right{display:flex; gap:8px; flex-wrap:wrap}
    .watermark{opacity:.75; font-size:12px; color:var(--muted)}
    a.link{color:#2a5ce6; text-decoration:none} a.link:hover{text-decoration:underline}

    /* —Ü–≤–µ—Ç–Ω–∏ ‚Äû—Ç–æ—á–∫–∏‚Äú –ø–æ —Ç–∏–ø */
    .dot{display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:8px}
    .dot-go{background:#5ba7ff}     /* –ì–û */
    .dot-gtp{background:#7dd3fc}    /* –ì–¢–ü */
    .dot-vin{background:#ffd166}    /* –≤–∏–Ω–µ—Ç–∫–∞ */
    .dot-oil{background:#ffb86b}    /* –º–∞—Å–ª–æ */
    .dot-filter{background:#a7f3d0} /* —Ñ–∏–ª—Ç—Ä–∏ */
    .dot-brake{background:#ff8b8b}  /* –Ω–∞–∫–ª–∞–¥–∫–∏ */
    .dot-belt{background:#c7b7ff}   /* —Ä–µ–º—ä–∫ */
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand">üöó AutoNotify BG ‚Äî –°–µ—Ä–≤–∏–∑–Ω–∞ –∫–Ω–∏–∂–∫–∞</div>
    <div class="nav">
      <button class="btn" data-tab="dashboard">–¢–∞–±–ª–æ</button>
      <button class="btn" data-tab="vehicles">–ú–ü–°</button>
      <button class="btn" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="btn secondary" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="btn secondary" id="installBtn" style="display:none">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π</button>
    </div>
  </div>

  <!-- TABLO -->
  <section id="tab-dashboard" class="card">
    <h3>–°–ª–µ–¥–≤–∞—â–∏ –∑–∞–¥–∞—á–∏</h3>
    <div id="todoList"></div>
    <div class="sep"></div>
    <div class="chips small">
      <div class="chip"><span class="ok">–∑–µ–ª–µ–Ω–æ</span> ‚Äî –≤—Å–∏—á–∫–æ –µ –Ω–∞—Ä–µ–¥</div>
      <div class="chip"><span class="warn">–∂—ä–ª—Ç–æ</span> ‚Äî &lt; 30 –¥–Ω–∏ –∏–ª–∏ &lt; 1000 –∫–º</div>
      <div class="chip"><span class="bad">—á–µ—Ä–≤–µ–Ω–æ</span> ‚Äî –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
    </div>
  </section>

  <!-- MPS -->
  <section id="tab-vehicles" class="card" style="display:none">
    <div class="right" style="justify-content:space-between; margin-bottom:8px">
      <h3>–ú–æ–∏—Ç–µ –ú–ü–°</h3>
      <div class="right">
        <button class="btn" onclick="openVehicleEditor()">–î–æ–±–∞–≤–∏ –ú–ü–°</button>
        <button class="btn secondary" onclick="exportAllICS()">–ï–∫—Å–ø–æ—Ä—Ç .ics</button>
      </div>
    </div>
    <div id="vehicleList"></div>
  </section>

  <!-- ISTORIA -->
  <section id="tab-history" class="card" style="display:none">
    <div class="right" style="justify-content:space-between; margin-bottom:8px">
      <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
      <button class="btn secondary" onclick="clearHistory()">–ò–∑—á–∏—Å—Ç–∏</button>
    </div>
    <div id="historyList"></div>
  </section>

  <!-- NASTROYKI -->
  <section id="tab-settings" class="card" style="display:none">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <div class="row">
      <div class="col-4">
        <label>–ß–∞—Å –∑–∞ –Ω–∞–ø–æ–º–Ω—è–Ω–∏—è</label>
        <input id="cfg_hour" type="time" value="09:00" />
      </div>
      <div class="col-8">
        <label>–ü—Ä–µ–¥–∏–∑–≤–µ—Å—Ç–∏–µ (–¥–Ω–∏)</label>
        <div class="chips">
          <label class="chip"><input id="cfg_d30" type="checkbox" checked/> 30</label>
          <label class="chip"><input id="cfg_d10" type="checkbox" checked/> 10</label>
          <label class="chip"><input id="cfg_d5"  type="checkbox" checked/> 5</label>
          <label class="chip"><input id="cfg_d1"  type="checkbox" checked/> 1</label>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="watermark">
      –ê–≤—Ç–æ—Ä: –°—Ç–∞–Ω–∏—Å–ª–∞–≤ –ö—Ä—ä—Å—Ç–µ–≤ ‚Ä¢ ‚úâÔ∏è <a class="link" href="mailto:stanislav90030@gmail.com">stanislav90030@gmail.com</a> ‚Ä¢ ‚òé +359 883 482 854
    </div>
  </section>

  <!-- EDITOR -->
  <section id="editor" class="card" style="display:none">
    <h3 id="editorTitle">–ú–ü–°</h3>
    <div class="row">
      <div class="col-4"><label>–ò–º–µ/–†–µ–≥. –Ω–æ–º–µ—Ä</label><input id="e_name" placeholder="–Ω–∞–ø—Ä. A1234BC –∏–ª–∏ BMW 320d"/></div>
      <div class="col-4"><label>–°–æ–±—Å—Ç–≤–µ–Ω–∏–∫ (–ø–æ –∏–∑–±–æ—Ä)</label><input id="e_owner" placeholder="–Ω–∞–ø—Ä. –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"/></div>
      <div class="col-4"><label>–¢–µ–∫—É—â –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂</label><input id="e_odometer" type="number" min="0" step="1" placeholder="–∫–º"/></div>

      <div class="col-3"><label>–ì–û ‚Äì –Ω–∞—á–∞–ª–æ</label><input id="e_go_start" type="date"/></div>
      <div class="col-3">
        <label>–ì–û ‚Äì –≤–Ω–æ—Å–∫–∏</label>
        <select id="e_go_plan">
          <option value="1">1 –≤–Ω–æ—Å–∫–∞ (–≥–æ–¥–∏—à–Ω–æ)</option>
          <option value="2">2 –≤–Ω–æ—Å–∫–∏ (–Ω–∞ 6 –º.)</option>
          <option value="4">4 –≤–Ω–æ—Å–∫–∏ (–Ω–∞ 3 –º.)</option>
        </select>
      </div>
      <div class="col-3"><label>–ì–¢–ü ‚Äì –¥–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–≥–ª–µ–¥–∞</label><input id="e_gtp" type="date"/></div>

      <div class="col-3">
        <label>–í–∏–Ω–µ—Ç–∫–∞ ‚Äì —Ç–∏–ø</label>
        <select id="e_vignette_type">
          <option value="1">1 –º–µ—Å–µ—Ü</option>
          <option value="3">3 –º–µ—Å–µ—Ü–∞</option>
          <option value="12" selected>12 –º–µ—Å–µ—Ü–∞</option>
        </select>
      </div>
      <div class="col-3"><label>–í–∏–Ω–µ—Ç–∫–∞ ‚Äì –Ω–∞—á–∞–ª–æ</label><input id="e_vignette_start" type="date"/></div>

      <div class="col-3"><label>–ú–∞—Å–ª–æ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_oil_km" type="number" min="0" step="500" placeholder="–Ω–∞–ø—Ä. 10000"/></div>
      <div class="col-3"><label>–ú–∞—Å–ª–æ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–º–µ—Å.)</label><input id="e_oil_mo" type="number" min="0" step="1" placeholder="–Ω–∞–ø—Ä. 12"/></div>
      <div class="col-3"><label>–§–∏–ª—Ç—ä—Ä –º–∞—Å–ª–µ–Ω ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_of_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ì–æ—Ä–∏–≤–µ–Ω —Ñ–∏–ª—Ç—ä—Ä ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_ff_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ü–æ–ª–µ–Ω–æ–≤/–∫–ª–∏–º–∞—Ç–∏–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–º–µ—Å.)</label><input id="e_cabin_mo" type="number" min="0" step="1"/></div>
      <div class="col-3"><label>–í—ä–∑–¥—É—à–µ–Ω —Ñ–∏–ª—Ç—ä—Ä ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_air_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ù–∞–∫–ª–∞–¥–∫–∏ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_pads_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_belt_km" type="number" min="0" step="1000"/></div>
      <div class="col-3"><label>–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≥–æ–¥.)</label><input id="e_belt_yr" type="number" min="0" step="1"/></div>
    </div>
    <div class="sep"></div>
    <div class="right">
      <button class="btn" onclick="saveVehicle()">–ó–∞–ø–∞–∑–∏</button>
      <button class="btn secondary" onclick="closeVehicleEditor()">–û—Ç–º–µ–Ω–∏</button>
      <button class="btn secondary" id="delBtn" style="display:none" onclick="deleteVehicle()">–ò–∑—Ç—Ä–∏–π</button>
    </div>
  </section>
</div>

<script>
/* ===== model & storage ===== */
const KEY='autonotify_servicebook_v1';
let db = { cfg:{hour:'09:00', d30:true, d10:true, d5:true, d1:true}, vehicles:[], history:[] };
let editId=null;
function load(){ try{ db = JSON.parse(localStorage.getItem(KEY)) || db; }catch{} applyCfgUI(); renderAll(); }
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }

/* helpers */
const addDays=(d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const addMonths=(d,m)=>{ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; };
const addYears=(d,y)=>{ const x=new Date(d); x.setFullYear(x.getFullYear()+y); return x; };
const fmt=(d)=> d? new Date(d).toLocaleDateString('bg-BG'):'‚Äî';
const daysLeft=(d)=> d? Math.ceil((new Date(d).setHours(0,0,0,0)-Date.now())/86400000): 9e9;
const statusClass=(n)=> n<=0?'bad':(n<=30?'warn':'ok');
const kmClass=(n)=> n<=0?'bad':(n<=1000?'warn':'ok');

/* business */
function tasksForVehicle(v){
  const out=[]; const today=new Date();
  if(v.goStart){
    out.push({veh:v.name, type:'–ì–û –∏–∑—Ç–∏—á–∞', date:addYears(v.goStart,1)});
    const plan=Number(v.goPlan||1), inst=plan===1?[0]:(plan===2?[0,6]:[0,3,6,9]);
    inst.forEach(m=> out.push({veh:v.name, type:`–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞ ${m===0?1:(m/3+1)}`, date:addMonths(v.goStart,m)}));
  }
  if(v.gtp){ out.push({veh:v.name, type:'–ì–¢–ü –∏–∑—Ç–∏—á–∞', date:addYears(v.gtp,1)}); }
  if(v.vigStart && v.vigType){ out.push({veh:v.name, type:'–í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞', date:addMonths(v.vigStart, Number(v.vigType))}); }

  const o=Number(v.odometer||0);
  const kmTask=(label,lastKm,intervalKm)=>{ if(!intervalKm) return; const next=o+Number(intervalKm); out.push({veh:v.name,type:label,kmDue:next,kmLeft:next-o}); };
  kmTask('–°–º—è–Ω–∞ –º–∞—Å–ª–æ',  o, v.oilKm);
  kmTask('–ú–∞—Å–ª–µ–Ω —Ñ–∏–ª—Ç—ä—Ä',o, v.ofKm);
  kmTask('–ì–æ—Ä–∏–≤–µ–Ω —Ñ–∏–ª—Ç—ä—Ä',o, v.ffKm);
  kmTask('–í—ä–∑–¥—É—à–µ–Ω —Ñ–∏–ª—Ç—ä—Ä',o, v.airKm);
  kmTask('–ù–∞–∫–ª–∞–¥–∫–∏',o, v.padsKm);
  kmTask('–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ (–∫–º)',o, v.beltKm);
  if(v.beltYr){ out.push({veh:v.name, type:'–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ (–≥.)', date:addYears(v.beltStart||today, Number(v.beltYr))}); }
  return out;
}
function allTasks(){
  let arr=[]; db.vehicles.forEach(v=> arr=arr.concat(tasksForVehicle(v)));
  arr.forEach(t=>{ if(t.date){ t.days=daysLeft(t.date); }});
  arr.sort((a,b)=>{ const ad=(a.date?a.days:9e9), bd=(b.date?b.days:9e9); if(ad!==bd) return ad-bd; return (a.kmLeft??9e9)-(b.kmLeft??9e9); });
  return arr;
}

/* render */
function iconDot(type){
  if(type.startsWith('–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞') || type.startsWith('–ì–û ')) return 'dot-go';
  if(type.startsWith('–ì–¢–ü')) return 'dot-gtp';
  if(type.startsWith('–í–∏–Ω–µ—Ç–∫–∞')) return 'dot-vin';
  if(type.includes('–º–∞—Å–ª–æ')) return 'dot-oil';
  if(type.includes('—Ñ–∏–ª—Ç—ä—Ä')) return 'dot-filter';
  if(type.includes('–ù–∞–∫–ª–∞–¥–∫–∏')) return 'dot-brake';
  if(type.includes('–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω')) return 'dot-belt';
  return 'dot-go';
}
function renderDashboard(){
  const L=document.getElementById('todoList');
  const tasks=allTasks().slice(0,24);
  if(!tasks.length){ L.innerHTML='<div class="item" style="justify-content:center">–ù—è–º–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏ –∑–∞–¥–∞—á–∏. –î–æ–±–∞–≤–∏ –ú–ü–° –æ—Ç —Ä–∞–∑–¥–µ–ª ‚Äû–ú–ü–°‚Äú.</div>'; return; }
  L.innerHTML = tasks.map(t=>{
    if(t.date){
      const cls=statusClass(t.days), value=(t.days<=0?'–∏–∑—Ç–µ–∫–ª–æ':t.days+' –¥–Ω–∏');
      return `<div class="item">
        <div>
          <div class="item-title"><span class="dot ${iconDot(t.type)}"></span>${t.type}</div>
          <div class="item-sub">${t.veh||'–ú–ü–°'} ‚Äî –¥–æ: ${fmt(t.date)}</div>
        </div>
        <div class="badge ${cls}">${value}</div>
      </div>`;
    }else{
      const left=t.kmLeft, cls=kmClass(left), value=(left<=0?'–ø—Ä–æ—Å—Ä.':left+' –∫–º');
      return `<div class="item">
        <div>
          <div class="item-title"><span class="dot ${iconDot(t.type)}"></span>${t.type}</div>
          <div class="item-sub">${t.veh||'–ú–ü–°'} ‚Äî –Ω–∞: ${t.kmDue} –∫–º</div>
        </div>
        <div class="badge ${cls}">${value}</div>
      </div>`;
    }
  }).join('');
}
function renderVehicles(){
  const L=document.getElementById('vehicleList');
  if(!db.vehicles.length){ L.innerHTML='<div class="item" style="justify-content:center">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ú–ü–°.</div>'; return; }
  L.innerHTML = db.vehicles.map(v=>`
    <div class="item">
      <div>
        <div class="item-title">${v.name||'–ú–ü–°'} ${v.owner?('<span class="small" style="color:var(--muted)">‚Ä¢ '+v.owner+'</span>'):''}</div>
        <div class="item-sub">–ì–û ${v.goStart?('–æ—Ç '+fmt(v.goStart)):'‚Äî'} ‚Ä¢ –ì–¢–ü ${v.gtp?fmt(v.gtp):'‚Äî'} ‚Ä¢ –í–∏–Ω–µ—Ç–∫–∞ ${v.vigStart?('–æ—Ç '+fmt(v.vigStart)+'/'+v.vigType+' –º.'):'‚Äî'} ‚Ä¢ –∫–º: ${v.odometer||0}</div>
      </div>
      <div class="right">
        <button class="btn secondary" onclick="editVehicle('${v.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
        <button class="btn secondary" onclick="downloadICS('${v.id}')">.ics</button>
      </div>
    </div>`).join('');
}
function renderHistory(){
  const L=document.getElementById('historyList');
  if(!db.history.length){ L.innerHTML='<div class="item" style="justify-content:center">–í—Å–µ –æ—â–µ –Ω—è–º–∞ –∑–∞–ø–∏—Å–∏.</div>'; return; }
  L.innerHTML = db.history.map(h=>`<div class="item">
    <div><b>${h.type}</b> ‚Ä¢ ${h.vehicle} ‚Äî ${fmt(h.date)} ‚Ä¢ ${h.odometer||0} –∫–º</div>
    <div class="item-sub">${h.notes||''} ${h.cost?('‚Ä¢ '+h.cost+' –ª–≤.'):''}</div>
  </div>`).join('');
}
function renderAll(){ renderDashboard(); renderVehicles(); renderHistory(); }

/* crud */
function openVehicleEditor(){ editId=null; editorTitle.textContent='–ù–æ–≤–æ –ú–ü–°';
  ['e_name','e_owner','e_odometer','e_go_start','e_go_plan','e_gtp','e_vignette_type','e_vignette_start','e_oil_km','e_oil_mo','e_of_km','e_ff_km','e_cabin_mo','e_air_km','e_pads_km','e_belt_km','e_belt_yr'].forEach(id=>{
    const el=document.getElementById(id); if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
  });
  delBtn.style.display='none'; editor.style.display='block';
}
function closeVehicleEditor(){ editor.style.display='none'; }
function editVehicle(id){
  const v=db.vehicles.find(x=>x.id===id); if(!v) return;
  editId=id; editorTitle.textContent='–†–µ–¥–∞–∫—Ü–∏—è';
  e_name.value=v.name||''; e_owner.value=v.owner||''; e_odometer.value=v.odometer||'';
  e_go_start.value=v.goStart||''; e_go_plan.value=String(v.goPlan||1);
  e_gtp.value=v.gtp||''; e_vignette_type.value=String(v.vigType||12); e_vignette_start.value=v.vigStart||'';
  e_oil_km.value=v.oilKm||''; e_oil_mo.value=v.oilMo||''; e_of_km.value=v.ofKm||''; e_ff_km.value=v.ffKm||'';
  e_cabin_mo.value=v.cabinMo||''; e_air_km.value=v.airKm||''; e_pads_km.value=v.padsKm||'';
  e_belt_km.value=v.beltKm||''; e_belt_yr.value=v.beltYr||'';
  delBtn.style.display='inline-flex'; editor.style.display='block';
}
function saveVehicle(){
  const v={
    id: editId || Math.random().toString(36).slice(2),
    name:e_name.value.trim(), owner:e_owner.value.trim(), odometer:Number(e_odometer.value||0),
    goStart:e_go_start.value||null, goPlan:Number(e_go_plan.value||1),
    gtp:e_gtp.value||null, vigType:Number(e_vignette_type.value||12), vigStart:e_vignette_start.value||null,
    oilKm:Number(e_oil_km.value||0), oilMo:Number(e_oil_mo.value||0),
    ofKm:Number(e_of_km.value||0), ffKm:Number(e_ff_km.value||0),
    cabinMo:Number(e_cabin_mo.value||0), airKm:Number(e_air_km.value||0),
    padsKm:Number(e_pads_km.value||0), beltKm:Number(e_belt_km.value||0), beltYr:Number(e_belt_yr.value||0)
  };
  if(editId){ db.vehicles=db.vehicles.map(x=>x.id===editId?v:x);} else { db.vehicles.push(v); }
  save(); closeVehicleEditor(); renderAll();
}
function deleteVehicle(){ if(!editId) return; db.vehicles=db.vehicles.filter(x=>x.id!==editId); save(); closeVehicleEditor(); renderAll(); }

/* ics */
function makeIcsForVehicle(v){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//AutoNotifyBG//ServiceBook//BG'];
  const addEvent=(title,date)=>{
    if(!date) return; const dt=new Date(date); dt.setHours(9,0,0,0);
    const stamp=dt.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
    const uid=Math.random().toString(36).slice(2)+'@autonotify.bg';
    lines.push('BEGIN:VEVENT','UID:'+uid,'DTSTAMP:'+stamp,'DTSTART:'+stamp,'SUMMARY:'+title+' ‚Ä¢ '+(v.name||'–ú–ü–°'));
    const c=db.cfg, a=[]; if(c.d30)a.push('-P30D'); if(c.d10)a.push('-P10D'); if(c.d5)a.push('-P5D'); if(c.d1)a.push('-P1D');
    a.forEach(x=>lines.push('BEGIN:VALARM','TRIGGER:'+x,'ACTION:DISPLAY','DESCRIPTION:–ù–∞–ø–æ–º–Ω—è–Ω–µ','END:VALARM'));
    lines.push('END:VEVENT');
  };
  if(v.goStart){ addEvent('–ì–û –∏–∑—Ç–∏—á–∞', addYears(v.goStart,1));
    (Number(v.goPlan||1)===1?[0]:(Number(v.goPlan||1)===2?[0,6]:[0,3,6,9]))
      .forEach((m,i)=> addEvent('–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞ '+(i+1), addMonths(v.goStart,m)));
  }
  if(v.gtp) addEvent('–ì–¢–ü –∏–∑—Ç–∏—á–∞', addYears(v.gtp,1));
  if(v.vigStart&&v.vigType) addEvent('–í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞', addMonths(v.vigStart, Number(v.vigType)));
  lines.push('END:VCALENDAR'); return lines.join('\r\n');
}
function download(name,content){ const a=document.createElement('a'); a.href='data:text/calendar;charset=utf-8,'+encodeURIComponent(content); a.download=name; a.click(); }
function downloadICS(id){ const v=db.vehicles.find(x=>x.id===id); if(!v) return; download((v.name||'mps')+'.ics', makeIcsForVehicle(v)); }
function exportAllICS(){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//AutoNotifyBG//ServiceBook//BG'];
  db.vehicles.forEach(v=>{ const p=makeIcsForVehicle(v).split('\r\n').filter(x=>!/^BEGIN:VCALENDAR|END:VCALENDAR$/.test(x)); lines.push(...p); });
  lines.push('END:VCALENDAR'); download('servicebook_all.ics', lines.join('\r\n'));
}

/* settings */
function applyCfgUI(){ cfg_hour.value=db.cfg.hour||'09:00'; cfg_d30.checked=!!db.cfg.d30; cfg_d10.checked=!!db.cfg.d10; cfg_d5.checked=!!db.cfg.d5; cfg_d1.checked=!!db.cfg.d1; }
;['cfg_hour','cfg_d30','cfg_d10','cfg_d5','cfg_d1'].forEach(id=>{
  document.getElementById(id).addEventListener('change',()=>{ db.cfg.hour=cfg_hour.value; db.cfg.d30=cfg_d30.checked; db.cfg.d10=cfg_d10.checked; db.cfg.d5=cfg_d5.checked; db.cfg.d1=cfg_d1.checked; save(); });
});

/* nav */
document.querySelectorAll('.nav .btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    const tab=b.dataset.tab;
    ['dashboard','vehicles','history','settings'].forEach(t=>{ document.getElementById('tab-'+t).style.display=(t===tab?'block':'none'); });
  });
});

/* pwa install */
let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; if(installBtn) installBtn.style.display='inline-flex'; });
if(installBtn){ installBtn.addEventListener('click', async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; }); }

/* boot */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(console.error)); }
load();
</script>
</body>
</html>
