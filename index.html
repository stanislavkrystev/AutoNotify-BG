<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoNotify BG ‚Äî –°–µ—Ä–≤–∏–∑–Ω–∞ –∫–Ω–∏–∂–∫–∞ (Calm Pastel + Timeline)</title>
  <meta name="theme-color" content="#f3f6ff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <!-- –ø—Ä–∏—è—Ç–µ–ª—Å–∫–∏, —á–µ—Ç–∏–º —à—Ä–∏—Ñ—Ç -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f6ff; --text:#1b2a38; --muted:#5d6b7a;
      --card: rgba(255,255,255,.85); --border:#e3e9fb;
      --shadow: 0 10px 30px rgba(32,58,92,.10);
      --accent:#5ba7ff; --accent-hover:#3f90f3;
      --ok:#28c76f; --warn:#f9a826; --bad:#ff6b6b;
      --r:14px; --pad:12px; --gap:10px;
    }
    :root.dark{
      --bg:#0b1020; --text:#e8ecf1; --muted:#a8b3d1;
      --card: rgba(18,26,51,.88); --border:#1b274d;
      --shadow: 0 10px 30px rgba(0,0,0,.28);
      --accent:#5ba7ff; --accent-hover:#3f90f3;
      --ok:#9BE7A3; --warn:#FFD166; --bad:#FF8B8B;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family:"Nunito", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, #edf3ff 0%, transparent 60%),
        radial-gradient(1000px 600px at 90% 110%, #f7f0ff 0%, transparent 55%),
        linear-gradient(180deg, #f7fbff 0%, #f3f6ff 100%);
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:url('./bg-portrait-1080x1920.webp') center/cover no-repeat;
      filter: saturate(.7) contrast(.9);
    }
    @media (min-aspect-ratio:16/10){
      body::before{ background-image:url('./bg-landscape-1920x1080.webp'); }
    }
    body::after{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1000px 600px at 90% 110%, rgba(255,255,255,.55), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.55));
      mix-blend-mode: lighten;
    }
    :root.dark body::after{
      background:
       radial-gradient(1200px 700px at 15% -10%, rgba(0,0,0,.32), transparent 60%),
       radial-gradient(1000px 600px at 90% 110%, rgba(0,0,0,.32), transparent 55%),
       linear-gradient(180deg, rgba(0,0,0,.38), rgba(0,0,0,.38));
      mix-blend-mode: normal;
    }

    .app{max-width:1180px; margin:0 auto; padding:18px}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .brand{font-weight:700}
    .nav{display:flex; gap:8px; flex-wrap:wrap}
    .today{color:var(--muted); font-weight:600}

    .btn{
      padding:10px 14px; border-radius:999px;
      background: var(--accent); border:1px solid #cfe0ff; color:white; font-weight:700;
      box-shadow: 0 6px 18px rgba(91,167,255,.25); cursor:pointer
    }
    .btn:hover{ background:var(--accent-hover) }
    .btn.secondary{
      background: white; color:var(--text); border:1px solid var(--border);
      box-shadow: 0 6px 18px rgba(20,40,80,.06);
    }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--r);
      padding:var(--pad); margin-bottom:12px; box-shadow:var(--shadow); backdrop-filter: blur(4px);
    }

    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:var(--gap)}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:#ffffff; color:var(--text); font-size:14px;
      box-shadow:0 1px 0 rgba(10,20,40,.02) inset;
    }
    input:focus,select:focus,textarea:focus{outline:none; border-color:#b9ccff; box-shadow:0 0 0 3px rgba(185,204,255,.35)}

    /* —Ç–∞–±–ª–æ */
    #todoList{ display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:12px; }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; border:1px solid var(--border); border-radius:16px; background:#ffffffc4;
      box-shadow: var(--shadow);
    }
    .item-title{font-weight:700}
    .item-sub{font-size:12px; color:var(--muted)}
    .badge{
      min-width:98px; text-align:center; padding:8px 10px; border-radius:10px; font-weight:700;
      background:#eef5ff; border:1px solid #d7e6ff; color:#2d4c7a;
    }
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{padding:3px 10px; border-radius:999px; border:1px solid var(--border); font-size:12px; background:#fff}
    .sep{height:1px; background:var(--border); opacity:.8; margin:8px 0}
    .right{display:flex; gap:8px; flex-wrap:wrap}
    .watermark{opacity:.75; font-size:12px; color:var(--muted)}
    a.link{color:#2a5ce6; text-decoration:none} a.link:hover{text-decoration:underline}

    /* timeline */
    .timeline-wrap{ position:relative; }
    .timeline-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    .timeline{ width:100%; height:160px; }
    .tl-label{ font-size:12px; fill:var(--muted); }
    .tl-line{ stroke:#cfe0ff; stroke-width:2; }
    .tl-today{ stroke:#5ba7ff; stroke-width:2; stroke-dasharray:4 4; }
    .tl-dot{ r:6; }
    .tl-badge{ font-weight:700; }
    .footer{
      display:flex; align-items:center; gap:8px; color:var(--muted);
      font-size:12px; padding:10px 0 20px;
    }

    /* –∏–∫–æ–Ω–∫–∞ */
    .icon{width:18px; height:18px; vertical-align:-3px; margin-right:6px; opacity:.9}
  </style>
</head>
<body>
<!-- SVG sprite (–∏–∫–æ–Ω–∏) -->
<svg width="0" height="0" style="position:absolute;opacity:0;pointer-events:none">
  <symbol id="i-go" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 5v5.2l4 2.3-.8 1.4L11 14V7h2Z"/></symbol>
  <symbol id="i-gtp" viewBox="0 0 24 24"><path fill="currentColor" d="M7 4h10l2 4v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8l2-4Zm0 4h10"/></symbol>
  <symbol id="i-vin" viewBox="0 0 24 24"><path fill="currentColor" d="M4 7h16v10H4z"/><path fill="currentColor" d="M6 5h12v2H6z"/></symbol>
  <symbol id="i-oil" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2s4 5 4 7a4 4 0 1 1-8 0c0-2 4-7 4-7Z"/></symbol>
  <symbol id="i-filter" viewBox="0 0 24 24"><path fill="currentColor" d="M4 5h16v2l-6 5v5l-4-2v-3L4 7V5Z"/></symbol>
  <symbol id="i-belt" viewBox="0 0 24 24"><path fill="currentColor" d="M4 12a8 8 0 1 1 16 0 8 8 0 0 1-16 0Zm3 0a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z"/></symbol>
</svg>

<div class="app">
  <div class="top">
    <div class="brand">üöó AutoNotify BG ‚Äî –°–µ—Ä–≤–∏–∑–Ω–∞ –∫–Ω–∏–∂–∫–∞</div>
    <div class="nav">
      <button class="btn" data-tab="dashboard">–¢–∞–±–ª–æ</button>
      <button class="btn" data-tab="vehicles">–ú–ü–°</button>
      <button class="btn" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="btn secondary" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="btn secondary" id="themeBtn">–¢—ä–º–Ω–æ</button>
      <button class="btn secondary" id="installBtn" style="display:none">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π</button>
    </div>
    <div class="today" id="todayBox"></div>
  </div>

  <!-- TABLO -->
  <section id="tab-dashboard" class="card">
    <h3>–°–ª–µ–¥–≤–∞—â–∏ –∑–∞–¥–∞—á–∏</h3>
    <div id="todoList"></div>
    <div class="sep"></div>
    <div class="chips small">
      <div class="chip"><span class="ok">–∑–µ–ª–µ–Ω–æ</span> ‚Äî –≤—Å–∏—á–∫–æ –µ –Ω–∞—Ä–µ–¥</div>
      <div class="chip"><span class="warn">–∂—ä–ª—Ç–æ</span> ‚Äî &lt; 30 –¥–Ω–∏ –∏–ª–∏ &lt; 1000 –∫–º</div>
      <div class="chip"><span class="bad">—á–µ—Ä–≤–µ–Ω–æ</span> ‚Äî –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
    </div>
  </section>

  <!-- TIMELINE -->
  <!-- SPARKLINE -->
<section class="card" id="spark-wrap">
  <div class="timeline-head" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <h3>–ù–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ –ø–æ –º–µ—Å–µ—Ü–∏ <span id="spYear"></span></h3>
    <div class="small" style="color:var(--muted)">–±—Ä–æ–π —Å—ä–±–∏—Ç–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –¥–∞—Ç–∞ –∑–∞ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –≥–æ–¥–∏–Ω–∞</div>
  </div>
  <svg id="spark" class="spark"></svg>
</section>

  <!-- MPS -->
  <section id="tab-vehicles" class="card" style="display:none">
    <div class="right" style="justify-content:space-between; margin-bottom:8px">
      <h3>–ú–æ–∏—Ç–µ –ú–ü–°</h3>
      <div class="right">
        <button class="btn" onclick="openVehicleEditor()">–î–æ–±–∞–≤–∏ –ú–ü–°</button>
        <button class="btn secondary" onclick="exportAllICS()">–ï–∫—Å–ø–æ—Ä—Ç .ics</button>
      </div>
    </div>
    <div id="vehicleList"></div>
  </section>

  <!-- ISTORIA -->
  <section id="tab-history" class="card" style="display:none">
    <div class="right" style="justify-content:space-between; margin-bottom:8px">
      <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
      <button class="btn secondary" onclick="clearHistory()">–ò–∑—á–∏—Å—Ç–∏</button>
    </div>
    <div id="historyList"></div>
  </section>

  <!-- NASTROYKI -->
  <section id="tab-settings" class="card" style="display:none">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <div class="row">
      <div class="col-4">
        <label>–ß–∞—Å –∑–∞ –Ω–∞–ø–æ–º–Ω—è–Ω–∏—è</label>
        <input id="cfg_hour" type="time" value="09:00" />
      </div>
      <div class="col-4">
        <label>–ü—Ä–µ–¥–∏–∑–≤–µ—Å—Ç–∏–µ (–¥–Ω–∏)</label>
        <div class="chips">
          <label class="chip"><input id="cfg_d30" type="checkbox" checked/> 30</label>
          <label class="chip"><input id="cfg_d10" type="checkbox" checked/> 10</label>
          <label class="chip"><input id="cfg_d5"  type="checkbox" checked/> 5</label>
          <label class="chip"><input id="cfg_d1"  type="checkbox" checked/> 1</label>
        </div>
      </div>
      <div class="col-4">
        <label>–ì–æ–¥–∏–Ω–∞ –Ω–∞ –ª–∏–Ω–∏—è—Ç–∞</label>
        <select id="cfg_timeline_year"></select>
      </div>
    </div>
    <div class="sep"></div>
    <div class="watermark">
      –ê–≤—Ç–æ—Ä: –°—Ç–∞–Ω–∏—Å–ª–∞–≤ –ö—Ä—ä—Å—Ç–µ–≤ ‚Ä¢ ‚úâÔ∏è <a class="link" href="mailto:stanislav90030@gmail.com">stanislav90030@gmail.com</a> ‚Ä¢ ‚òé +359 883 482 854
    </div>
  </section>

  <!-- EDITOR -->
  <section id="editor" class="card" style="display:none">
    <h3 id="editorTitle">–ú–ü–°</h3>
    <div class="row">
      <div class="col-4"><label>–ò–º–µ/–†–µ–≥. –Ω–æ–º–µ—Ä</label><input id="e_name" placeholder="–Ω–∞–ø—Ä. A1234BC –∏–ª–∏ BMW 320d"/></div>
      <div class="col-4"><label>–°–æ–±—Å—Ç–≤–µ–Ω–∏–∫ (–ø–æ –∏–∑–±–æ—Ä)</label><input id="e_owner" placeholder="–Ω–∞–ø—Ä. –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"/></div>
      <div class="col-4"><label>–¢–µ–∫—É—â –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂</label><input id="e_odometer" type="number" min="0" step="1" placeholder="–∫–º"/></div>

      <div class="col-3"><label>–ì–û ‚Äì –Ω–∞—á–∞–ª–æ</label><input id="e_go_start" type="date"/></div>
      <div class="col-3">
        <label>–ì–û ‚Äì –≤–Ω–æ—Å–∫–∏</label>
        <select id="e_go_plan">
          <option value="1">1 –≤–Ω–æ—Å–∫–∞ (–≥–æ–¥–∏—à–Ω–æ)</option>
          <option value="2">2 –≤–Ω–æ—Å–∫–∏ (–Ω–∞ 6 –º.)</option>
          <option value="4">4 –≤–Ω–æ—Å–∫–∏ (–Ω–∞ 3 –º.)</option>
        </select>
      </div>
      <div class="col-3"><label>–ì–¢–ü ‚Äì –¥–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–≥–ª–µ–¥–∞</label><input id="e_gtp" type="date"/></div>

      <div class="col-3">
        <label>–í–∏–Ω–µ—Ç–∫–∞ ‚Äì —Ç–∏–ø</label>
        <select id="e_vignette_type">
          <option value="1">1 –º–µ—Å–µ—Ü</option>
          <option value="3">3 –º–µ—Å–µ—Ü–∞</option>
          <option value="12" selected>12 –º–µ—Å–µ—Ü–∞</option>
        </select>
      </div>
      <div class="col-3"><label>–í–∏–Ω–µ—Ç–∫–∞ ‚Äì –Ω–∞—á–∞–ª–æ</label><input id="e_vignette_start" type="date"/></div>

      <div class="col-3"><label>–ú–∞—Å–ª–æ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_oil_km" type="number" min="0" step="500" placeholder="–Ω–∞–ø—Ä. 10000"/></div>
      <div class="col-3"><label>–ú–∞—Å–ª–æ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–º–µ—Å.)</label><input id="e_oil_mo" type="number" min="0" step="1" placeholder="–Ω–∞–ø—Ä. 12"/></div>
      <div class="col-3"><label>–§–∏–ª—Ç—ä—Ä –º–∞—Å–ª–µ–Ω ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_of_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ì–æ—Ä–∏–≤–µ–Ω —Ñ–∏–ª—Ç—ä—Ä ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_ff_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ü–æ–ª–µ–Ω–æ–≤/–∫–ª–∏–º–∞—Ç–∏–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–º–µ—Å.)</label><input id="e_cabin_mo" type="number" min="0" step="1"/></div>
      <div class="col-3"><label>–í—ä–∑–¥—É—à–µ–Ω —Ñ–∏–ª—Ç—ä—Ä ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_air_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ù–∞–∫–ª–∞–¥–∫–∏ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_pads_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_belt_km" type="number" min="0" step="1000"/></div>
      <div class="col-3"><label>–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≥–æ–¥.)</label><input id="e_belt_yr" type="number" min="0" step="1"/></div>
    </div>
    <div class="sep"></div>
    <div class="right">
      <button class="btn" onclick="saveVehicle()">–ó–∞–ø–∞–∑–∏</button>
      <button class="btn secondary" onclick="closeVehicleEditor()">–û—Ç–º–µ–Ω–∏</button>
      <button class="btn secondary" id="delBtn" style="display:none" onclick="deleteVehicle()">–ò–∑—Ç—Ä–∏–π</button>
    </div>
  </section>

  <!-- –¥–æ–ª–µ–Ω –≤–æ–¥–µ–Ω –∑–Ω–∞–∫ -->
  <div class="footer">
    Stanislav Krastev ‚Äî <a class="link" href="mailto:stanislav90030@gmail.com">stanislav90030@gmail.com</a> ‚Äî +359 883 482 854
  </div>
</div>

<script>
/* ===== model & storage ===== */
const KEY='autonotify_servicebook_v1';
let db = { cfg:{hour:'09:00', d30:true, d10:true, d5:true, d1:true, timelineYear:'current'}, vehicles:[], history:[] };
let editId=null;

function load(){ try{ db = JSON.parse(localStorage.getItem(KEY)) || db; }catch{} applyCfgUI(); renderAll(); }
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }

/* helpers */
const addDays=(d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const addMonths=(d,m)=>{ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; };
const addYears=(d,y)=>{ const x=new Date(d); x.setFullYear(x.getFullYear()+y); return x; };
const fmt=(d)=> d? new Date(d).toLocaleDateString('bg-BG'):'‚Äî';
const daysLeft=(d)=> d? Math.ceil((new Date(d).setHours(0,0,0,0)-Date.now())/86400000): 9e9;
const statusClass=(n)=> n<=0?'bad':(n<=30?'warn':'ok');
const kmClass=(n)=> n<=0?'bad':(n<=1000?'warn':'ok');
const dayOfYear=(date,year)=>{ const d=new Date(date); const y=year||d.getFullYear(); const start=new Date(y,0,1); const t=new Date(d); t.setFullYear(y); return Math.floor((t-start)/86400000)+1; };
const isLeap=(y)=> (new Date(y,1,29).getMonth()===1);

/* business */
function tasksForVehicle(v){
  const out=[]; const today=new Date();
  if(v.goStart){
    out.push({veh:v.name, type:'–ì–û –∏–∑—Ç–∏—á–∞', date:addYears(v.goStart,1)});
    const plan=Number(v.goPlan||1), inst=plan===1?[0]:(plan===2?[0,6]:[0,3,6,9]);
    inst.forEach(m=> out.push({veh:v.name, type:`–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞ ${m===0?1:(m/3+1)}`, date:addMonths(v.goStart,m)}));
  }
  if(v.gtp){ out.push({veh:v.name, type:'–ì–¢–ü –∏–∑—Ç–∏—á–∞', date:addYears(v.gtp,1)}); }
  if(v.vigStart && v.vigType){ out.push({veh:v.name, type:'–í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞', date:addMonths(v.vigStart, Number(v.vigType))}); }

  const o=Number(v.odometer||0);
  const kmTask=(label,lastKm,intervalKm)=>{ if(!intervalKm) return; const next=o+Number(intervalKm); out.push({veh:v.name,type:label,kmDue:next,kmLeft:next-o}); };
  kmTask('–°–º—è–Ω–∞ –º–∞—Å–ª–æ',o,v.oilKm); kmTask('–ú–∞—Å–ª–µ–Ω —Ñ–∏–ª—Ç—ä—Ä',o,v.ofKm); kmTask('–ì–æ—Ä–∏–≤–µ–Ω —Ñ–∏–ª—Ç—ä—Ä',o,v.ffKm);
  kmTask('–í—ä–∑–¥—É—à–µ–Ω —Ñ–∏–ª—Ç—ä—Ä',o,v.airKm); kmTask('–ù–∞–∫–ª–∞–¥–∫–∏',o,v.padsKm); kmTask('–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ (–∫–º)',o,v.beltKm);
  if(v.beltYr){ out.push({veh:v.name, type:'–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ (–≥.)', date:addYears(v.beltStart||today, Number(v.beltYr))}); }
  return out;
}
function allTasks(){
  let arr=[]; db.vehicles.forEach(v=> arr=arr.concat(tasksForVehicle(v)));
  arr.forEach(t=>{ if(t.date){ t.days=daysLeft(t.date); }});
  arr.sort((a,b)=>{ const ad=(a.date?a.days:9e9), bd=(b.date?b.days:9e9); if(ad!==bd) return ad-bd; return (a.kmLeft??9e9)-(b.kmLeft??9e9); });
  return arr;
}

/* render top "today" */
function renderToday(){
  const now = new Date();
  document.getElementById('todayBox').textContent = '–î–Ω–µ—Å: ' + now.toLocaleDateString('bg-BG');
}

/* render dashboard */
function iconId(type){
  if(type.startsWith('–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞') || type.startsWith('–ì–û ')) return 'i-go';
  if(type.startsWith('–ì–¢–ü')) return 'i-gtp';
  if(type.startsWith('–í–∏–Ω–µ—Ç–∫–∞')) return 'i-vin';
  if(type.includes('–º–∞—Å–ª–æ')) return 'i-oil';
  if(type.includes('—Ñ–∏–ª—Ç—ä—Ä')) return 'i-filter';
  if(type.includes('–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω')) return 'i-belt';
  return 'i-go';
}
function renderDashboard(){
  const L=document.getElementById('todoList');
  const tasks=allTasks().slice(0,24);
  if(!tasks.length){ L.innerHTML='<div class="item" style="justify-content:center">–ù—è–º–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏ –∑–∞–¥–∞—á–∏. –î–æ–±–∞–≤–∏ –ú–ü–° –æ—Ç —Ä–∞–∑–¥–µ–ª ‚Äû–ú–ü–°‚Äú.</div>'; return; }
  L.innerHTML = tasks.map(t=>{
    if(t.date){
      const cls=statusClass(t.days), value=(t.days<=0?'–∏–∑—Ç–µ–∫–ª–æ':t.days+' –¥–Ω–∏');
      return `<div class="item">
        <div>
          <div class="item-title"><svg class="icon"><use href="#${iconId(t.type)}"/></svg>${t.type}</div>
          <div class="item-sub">${t.veh||'–ú–ü–°'} ‚Äî –¥–æ: ${fmt(t.date)}</div>
        </div>
        <div class="badge ${cls}">${value}</div>
      </div>`;
    }else{
      const left=t.kmLeft, cls=kmClass(left), value=(left<=0?'–ø—Ä–æ—Å—Ä.':left+' –∫–º');
      return `<div class="item">
        <div>
          <div class="item-title"><svg class="icon"><use href="#${iconId(t.type)}"/></svg>${t.type}</div>
          <div class="item-sub">${t.veh||'–ú–ü–°'} ‚Äî –Ω–∞: ${t.kmDue} –∫–º</div>
        </div>
        <div class="badge ${cls}">${value}</div>
      </div>`;
    }
  }).join('');
}

/* render vehicles / history */
function renderVehicles(){
  const L=document.getElementById('vehicleList');
  if(!db.vehicles.length){ L.innerHTML='<div class="item" style="justify-content:center">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ú–ü–°.</div>'; return; }
  L.innerHTML = db.vehicles.map(v=>`
    <div class="item">
      <div>
        <div class="item-title">${v.name||'–ú–ü–°'} ${v.owner?('<span class="small" style="color:var(--muted)">‚Ä¢ '+v.owner+'</span>'):''}</div>
        <div class="item-sub">–ì–û ${v.goStart?('–æ—Ç '+fmt(v.goStart)):'‚Äî'} ‚Ä¢ –ì–¢–ü ${v.gtp?fmt(v.gtp):'‚Äî'} ‚Ä¢ –í–∏–Ω–µ—Ç–∫–∞ ${v.vigStart?('–æ—Ç '+fmt(v.vigStart)+'/'+v.vigType+' –º.'):'‚Äî'} ‚Ä¢ –∫–º: ${v.odometer||0}</div>
      </div>
      <div class="right">
        <button class="btn secondary" onclick="editVehicle('${v.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
        <button class="btn secondary" onclick="downloadICS('${v.id}')">.ics</button>
      </div>
    </div>`).join('');
}
function renderHistory(){
  const L=document.getElementById('historyList');
  if(!db.history.length){ L.innerHTML='<div class="item" style="justify-content:center">–í—Å–µ –æ—â–µ –Ω—è–º–∞ –∑–∞–ø–∏—Å–∏.</div>'; return; }
  L.innerHTML = db.history.map(h=>`<div class="item">
    <div><b>${h.type}</b> ‚Ä¢ ${h.vehicle} ‚Äî ${fmt(h.date)} ‚Ä¢ ${h.odometer||0} –∫–º</div>
    <div class="item-sub">${h.notes||''} ${h.cost?('‚Ä¢ '+h.cost+' –ª–≤.'):''}</div>
  </div>`).join('');
}

/* ===== Timeline ===== */
function timelineYearValue(){
  const sel = db.cfg.timelineYear;
  if(sel==='current') return new Date().getFullYear();
  return Number(sel)||new Date().getFullYear();
}
function tasksWithDates(){
  return allTasks().filter(t=> !!t.date);
}
function renderTimeline(){
  const year = timelineYearValue();
  document.getElementById('tlYearLabel').textContent = year;
  const svg = document.getElementById('timeline');
  const width = svg.clientWidth || svg.parentElement.clientWidth;
  const height = svg.clientHeight || 160;
  const pad = 30; const lineY = Math.floor(height/2)+10;
  const days = isLeap(year)?366:365;

  // build SVG
  const ns = 'http://www.w3.org/2000/svg';
  svg.innerHTML='';

  // baseline
  const line = document.createElementNS(ns,'line');
  line.setAttribute('x1', pad); line.setAttribute('x2', width-pad);
  line.setAttribute('y1', lineY); line.setAttribute('y2', lineY);
  line.setAttribute('class','tl-line');
  line.setAttribute('stroke','currentColor'); line.style.strokeOpacity = (getComputedStyle(document.documentElement).getPropertyValue('--muted')) ? 0.3 : 0.3;
  svg.appendChild(line);

  // month ticks
  for(let m=0;m<12;m++){
    const d = new Date(year, m, 1);
    const day = dayOfYear(d,year);
    const x = pad + (day-1)*(width-2*pad)/days;
    const tick = document.createElementNS(ns,'line');
    tick.setAttribute('x1',x); tick.setAttribute('x2',x);
    tick.setAttribute('y1', lineY-6); tick.setAttribute('y2', lineY+6);
    tick.setAttribute('stroke','#cfe0ff'); tick.setAttribute('stroke-width','1');
    svg.appendChild(tick);

    const lbl = document.createElementNS(ns,'text');
    lbl.setAttribute('x',x+2); lbl.setAttribute('y', lineY-10);
    lbl.setAttribute('class','tl-label');
    lbl.textContent = d.toLocaleString('bg-BG',{month:'short'});
    svg.appendChild(lbl);
  }

  // today marker (—Å–∞–º–æ –∞–∫–æ –≥–æ–¥–∏–Ω–∞—Ç–∞ –µ —Ç–µ–∫—É—â–∞)
  const now = new Date();
  if(year===now.getFullYear()){
    const dx = pad + (dayOfYear(now,year)-1)*(width-2*pad)/days;
    const tline = document.createElementNS(ns,'line');
    tline.setAttribute('x1',dx); tline.setAttribute('x2',dx);
    tline.setAttribute('y1', lineY-45); tline.setAttribute('y2', lineY+45);
    tline.setAttribute('class','tl-today');
    tline.setAttribute('stroke','#5ba7ff');
    svg.appendChild(tline);

    const ttxt = document.createElementNS(ns,'text');
    ttxt.setAttribute('x',dx+4); ttxt.setAttribute('y', lineY-50);
    ttxt.setAttribute('class','tl-label');
    ttxt.textContent='–¥–Ω–µ—Å';
    svg.appendChild(ttxt);
  }

  // events
  const events = tasksWithDates();
  // —Ä–∞–∑–Ω–µ—Å–∏ –µ—Ç–∏–∫–µ—Ç–∏—Ç–µ (—Ä–µ–¥—É–≤–∞—Ç —Å–µ –Ω–∞–¥/–ø–æ–¥)
  events.forEach((ev,i)=>{
    const d = new Date(ev.date); d.setFullYear(year); // –Ω–æ—Ä–º–∞–ª–∏–∑–∏—Ä–∞–π –≤ —Ç–∞–∑–∏ –≥–æ–¥–∏–Ω–∞
    const dd = dayOfYear(d,year);
    const x = pad + (dd-1)*(width-2*pad)/days;
    const y = lineY + (i%2===0? -24 : 24);

    const dot = document.createElementNS(ns,'circle');
    dot.setAttribute('cx',x); dot.setAttribute('cy',lineY);
    dot.setAttribute('class','tl-dot');
    let color = '#28c76f'; // ok
    const left = daysLeft(ev.date);
    if(left<=0) color = '#ff6b6b'; else if(left<=30) color = '#f9a826';
    dot.setAttribute('fill', color);
    svg.appendChild(dot);

    // label background
    const rect = document.createElementNS(ns,'rect');
    const text = document.createElementNS(ns,'text');
    const label = `${ev.type} ‚Ä¢ ${ev.veh||'–ú–ü–°'} ‚Ä¢ ${fmt(ev.date)}`;
    text.textContent = label;
    text.setAttribute('x', x+8); text.setAttribute('y', y);
    text.setAttribute('class','tl-label');
    svg.appendChild(text);
    // crude bbox estimate (no getBBox until in DOM): use text length
    const w = 7.2*label.length; const h = 18;
    rect.setAttribute('x', x+6); rect.setAttribute('y', y-14);
    rect.setAttribute('rx','8'); rect.setAttribute('ry','8');
    rect.setAttribute('width', w); rect.setAttribute('height', h);
    rect.setAttribute('fill', 'white');
    rect.setAttribute('stroke', '#e3e9fb');
    rect.setAttribute('opacity','0.85');
    // ensure rect behind text
    svg.insertBefore(rect, text);
  });
}

/* ===== CRUD / ICS (—Å—ä—â–æ—Ç–æ –∫–∞—Ç–æ –ø—Ä–µ–¥–∏) ===== */
function openVehicleEditor(){ editId=null; editorTitle.textContent='–ù–æ–≤–æ –ú–ü–°';
  ['e_name','e_owner','e_odometer','e_go_start','e_go_plan','e_gtp','e_vignette_type','e_vignette_start','e_oil_km','e_oil_mo','e_of_km','e_ff_km','e_cabin_mo','e_air_km','e_pads_km','e_belt_km','e_belt_yr'].forEach(id=>{
    const el=document.getElementById(id); if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
  });
  delBtn.style.display='none'; editor.style.display='block';
}
function closeVehicleEditor(){ editor.style.display='none'; }
function editVehicle(id){
  const v=db.vehicles.find(x=>x.id===id); if(!v) return;
  editId=id; editorTitle.textContent='–†–µ–¥–∞–∫—Ü–∏—è';
  e_name.value=v.name||''; e_owner.value=v.owner||''; e_odometer.value=v.odometer||'';
  e_go_start.value=v.goStart||''; e_go_plan.value=String(v.goPlan||1);
  e_gtp.value=v.gtp||''; e_vignette_type.value=String(v.vigType||12); e_vignette_start.value=v.vigStart||'';
  e_oil_km.value=v.oilKm||''; e_oil_mo.value=v.oilMo||''; e_of_km.value=v.ofKm||''; e_ff_km.value=v.ffKm||'';
  e_cabin_mo.value=v.cabinMo||''; e_air_km.value=v.airKm||''; e_pads_km.value=v.padsKm||'';
  e_belt_km.value=v.beltKm||''; e_belt_yr.value=v.beltYr||'';
  delBtn.style.display='inline-flex'; editor.style.display='block';
}
function saveVehicle(){
  const v={
    id: editId || Math.random().toString(36).slice(2),
    name:e_name.value.trim(), owner:e_owner.value.trim(), odometer:Number(e_odometer.value||0),
    goStart:e_go_start.value||null, goPlan:Number(e_go_plan.value||1),
    gtp:e_gtp.value||null, vigType:Number(e_vignette_type.value||12), vigStart:e_vignette_start.value||null,
    oilKm:Number(e_oil_km.value||0), oilMo:Number(e_oil_mo.value||0),
    ofKm:Number(e_of_km.value||0), ffKm:Number(e_ff_km.value||0),
    cabinMo:Number(e_cabin_mo.value||0), airKm:Number(e_air_km.value||0),
    padsKm:Number(e_pads_km.value||0), beltKm:Number(e_belt_km.value||0), beltYr:Number(e_belt_yr.value||0)
  };
  if(editId){ db.vehicles=db.vehicles.map(x=>x.id===editId?v:x);} else { db.vehicles.push(v); }
  save(); closeVehicleEditor(); renderAll();
}
function deleteVehicle(){ if(!editId) return; db.vehicles=db.vehicles.filter(x=>x.id!==editId); save(); closeVehicleEditor(); renderAll(); }

/* ics */
function makeIcsForVehicle(v){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//AutoNotifyBG//ServiceBook//BG'];
  const addEvent=(title,date)=>{
    if(!date) return; const dt=new Date(date); dt.setHours(9,0,0,0);
    const stamp=dt.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
    const uid=Math.random().toString(36).slice(2)+'@autonotify.bg';
    lines.push('BEGIN:VEVENT','UID:'+uid,'DTSTAMP:'+stamp,'DTSTART:'+stamp,'SUMMARY:'+title+' ‚Ä¢ '+(v.name||'–ú–ü–°'));
    const c=db.cfg, a=[]; if(c.d30)a.push('-P30D'); if(c.d10)a.push('-P10D'); if(c.d5)a.push('-P5D'); if(c.d1)a.push('-P1D');
    a.forEach(x=>lines.push('BEGIN:VALARM','TRIGGER:'+x,'ACTION:DISPLAY','DESCRIPTION:–ù–∞–ø–æ–º–Ω—è–Ω–µ','END:VALARM'));
    lines.push('END:VEVENT');
  };
  if(v.goStart){ addEvent('–ì–û –∏–∑—Ç–∏—á–∞', addYears(v.goStart,1));
    (Number(v.goPlan||1)===1?[0]:(Number(v.goPlan||1)===2?[0,6]:[0,3,6,9]))
      .forEach((m,i)=> addEvent('–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞ '+(i+1), addMonths(v.goStart,m)));
  }
  if(v.gtp) addEvent('–ì–¢–ü –∏–∑—Ç–∏—á–∞', addYears(v.gtp,1));
  if(v.vigStart&&v.vigType) addEvent('–í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞', addMonths(v.vigStart, Number(v.vigType)));
  lines.push('END:VCALENDAR'); return lines.join('\r\n');
}
function download(name,content){ const a=document.createElement('a'); a.href='data:text/calendar;charset=utf-8,'+encodeURIComponent(content); a.download=name; a.click(); }
function downloadICS(id){ const v=db.vehicles.find(x=>x.id===id); if(!v) return; download((v.name||'mps')+'.ics', makeIcsForVehicle(v)); }
function exportAllICS(){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//AutoNotifyBG//ServiceBook//BG'];
  db.vehicles.forEach(v=>{ const p=makeIcsForVehicle(v).split('\r\n').filter(x=>!/^BEGIN:VCALENDAR|END:VCALENDAR$/.test(x)); lines.push(...p); });
  lines.push('END:VCALENDAR'); download('servicebook_all.ics', lines.join('\r\n'));
}

/* settings */
function applyCfgUI(){
  cfg_hour.value=db.cfg.hour||'09:00'; cfg_d30.checked=!!db.cfg.d30; cfg_d10.checked=!!db.cfg.d10; cfg_d5.checked=!!db.cfg.d5; cfg_d1.checked=!!db.cfg.d1;
  // timeline year options
  const nowY = new Date().getFullYear();
  const opts = ['current', nowY-1, nowY, nowY+1, nowY+2];
  cfg_timeline_year.innerHTML = opts.map(v=>`<option value="${v}" ${String(v)===String(db.cfg.timelineYear)?'selected':''}>${v==='current'?'–¢–µ–∫—É—â–∞':v}</option>`).join('');
}
;['cfg_hour','cfg_d30','cfg_d10','cfg_d5','cfg_d1','cfg_timeline_year'].forEach(id=>{
  document.addEventListener('change', (e)=> {
    if(e.target && e.target.id===id){
      db.cfg.hour=cfg_hour.value; db.cfg.d30=cfg_d30.checked; db.cfg.d10=cfg_d10.checked; db.cfg.d5=cfg_d5.checked; db.cfg.d1=cfg_d1.checked;
      db.cfg.timelineYear = cfg_timeline_year.value;
      save(); renderTimeline();
    }
  });
});

/* nav */
document.querySelectorAll('.nav .btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    const tab=b.dataset.tab;
    ['dashboard','vehicles','history','settings'].forEach(t=>{ document.getElementById('tab-'+t)?.style && (document.getElementById('tab-'+t).style.display=(t===tab?'block':'none')); });
  });
});

/* theme toggle */
function applyTheme(){
  const mode = localStorage.getItem('theme') || 'light';
  document.documentElement.classList.toggle('dark', mode==='dark');
  document.getElementById('themeBtn').innerHTML = (mode==='dark'?'–°–≤–µ—Ç–ª–æ':'–¢—ä–º–Ω–æ');
}
document.getElementById('themeBtn').addEventListener('click', ()=>{
  const mode = (localStorage.getItem('theme') || 'light') === 'light' ? 'dark' : 'light';
  localStorage.setItem('theme', mode); applyTheme();
});

/* pwa install */
let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; if(installBtn) installBtn.style.display='inline-flex'; });
if(installBtn){ installBtn.addEventListener('click', async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; }); }

/* boot */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(console.error)); }
applyTheme();
renderToday();
load();
window.addEventListener('resize', ()=> renderTimeline()); // responsive timeline
</script>
</body>
</html>
