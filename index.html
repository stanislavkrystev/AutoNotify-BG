<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoNotify BG ‚Äî –°–µ—Ä–≤–∏–∑–Ω–∞ –∫–Ω–∏–∂–∫–∞ (MVP)</title>
  <meta name="theme-color" content="#0b1020" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <style>
    :root{ --r:16px;}
    *{box-sizing:border-box}

    /* === –§–û–ù: –º–∞–ª–∫–æ –ø–æ-—Å–≤–µ—Ç—ä–ª –≤–æ–∞–ª –∑–∞ –ø–æ-–∂–∏–≤ —Ñ–æ–Ω, –Ω–æ —á–µ—Ç–∏–º —Ç–µ–∫—Å—Ç === */
    body{ margin:0; min-height:100vh; color:#e8ecf1; background:#0b1020; }
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:url('./bg-portrait-1080x1920.webp') center/cover no-repeat;
    }
    @media (min-aspect-ratio:16/10){
      body::before{ background-image:url('./bg-landscape-1920x1080.webp'); }
    }
    body::after{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(0,0,0,.32), transparent 60%),
        radial-gradient(1000px 600px at 90% 110%, rgba(0,0,0,.32), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.38), rgba(0,0,0,.38));
    }

    /* === –õ–ï–ô–ê–£–¢/–ö–û–ú–ü–û–ù–ï–ù–¢–ò === */
    .app{max-width:1180px; margin:0 auto; padding:18px}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .brand{font-weight:700}
    .nav{display:flex; gap:8px; flex-wrap:wrap}
    .btn{padding:8px 12px; border-radius:12px; border:1px solid #2a3f7a; background:#162350; color:#e8ecf1; cursor:pointer; font-weight:600}
    .btn:hover{background:#1b2b61}
    .btn.secondary{background:transparent}
    .card{background:rgba(18,26,51,.85); backdrop-filter: blur(2px);
          border:1px solid #1b274d; border-radius:16px; padding:12px; margin-bottom:12px;
          box-shadow:0 10px 30px rgba(0,0,0,.28)}
    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:10px}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    label{display:block; font-size:12px; opacity:.92; margin-bottom:6px}
    input,select,textarea{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #243463; background:#0e1530; color:#e8ecf1; font-size:14px}
    input:focus,select:focus,textarea:focus{outline:none; border-color:#3a57a6; box-shadow:0 0 0 3px rgba(58,87,166,.25)}
    .muted{opacity:.85}.small{font-size:12px}

    /* === –¢–ê–ë–õ–û: –∞–¥–∞–ø—Ç–∏–≤–Ω–∞ —Ä–µ—à–µ—Ç–∫–∞ + –º–æ–¥–µ—Ä–Ω–∏ —Ä–µ–¥–æ–≤–µ === */
    #todoList{ display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:10px; }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px; border:1px solid #223566; border-radius:14px; background:#0e1530;
    }
    .item-title{font-weight:700; line-height:1.15}
    .item-sub{font-size:12px; opacity:.85}
    .badge{
      min-width:88px; text-align:center; padding:8px 10px; border-radius:12px;
      font-weight:700; border:1px solid #2a3f7a; background:#162350; box-shadow:0 2px 8px rgba(0,0,0,.25);
    }

    /* —Ü–≤–µ—Ç–æ–≤–µ/–∏–∫–æ–Ω–∏ */
    .ok{color:#b4f0b7} .warn{color:#ffd280} .bad{color:#ffb3b3}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{padding:2px 8px; border-radius:999px; border:1px solid #2a3f7a; font-size:12px}
    .sep{height:1px; background:#243463; opacity:.6; margin:8px 0}
    .right{display:flex; gap:8px; flex-wrap:wrap}
    .watermark{opacity:.8; font-size:12px}
    a.link{color:#a7c2ff; text-decoration:none} a.link:hover{text-decoration:underline}

    .dot{display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:8px}
    .dot-go{background:#5ac8fa} .dot-gtp{background:#64d2ff} .dot-vin{background:#ffd166}
    .dot-oil{background:#ff9f1a} .dot-filter{background:#a1e3a1} .dot-brake{background:#ff6b6b} .dot-belt{background:#c0a6ff}
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand">üöó AutoNotify BG ‚Äî –°–µ—Ä–≤–∏–∑–Ω–∞ –∫–Ω–∏–∂–∫–∞</div>
    <div class="nav">
      <button class="btn" data-tab="dashboard">–¢–∞–±–ª–æ</button>
      <button class="btn" data-tab="vehicles">–ú–ü–°</button>
      <button class="btn" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="btn secondary" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="btn secondary" id="installBtn" style="display:none">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="card">
    <h3>–°–ª–µ–¥–≤–∞—â–∏ –∑–∞–¥–∞—á–∏</h3>
    <div id="todoList"></div>
    <div class="sep"></div>
    <div class="chips small muted">
      <div class="chip"><span class="ok">–∑–µ–ª–µ–Ω–æ</span> ‚Äì –≤—Å–∏—á–∫–æ –µ –Ω–∞—Ä–µ–¥</div>
      <div class="chip"><span class="warn">–∂—ä–ª—Ç–æ</span> ‚Äì &lt; 30 –¥–Ω–∏ –∏–ª–∏ &lt; 1000 –∫–º</div>
      <div class="chip"><span class="bad">—á–µ—Ä–≤–µ–Ω–æ</span> ‚Äì –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
    </div>
  </section>

  <!-- VEHICLES -->
  <section id="tab-vehicles" class="card" style="display:none">
    <div class="right" style="justify-content:space-between; margin-bottom:8px">
      <h3>–ú–æ–∏—Ç–µ –ú–ü–°</h3>
      <div class="right">
        <button class="btn" onclick="openVehicleEditor()">–î–æ–±–∞–≤–∏ –ú–ü–°</button>
        <button class="btn secondary" onclick="exportAllICS()">–ï–∫—Å–ø–æ—Ä—Ç .ics</button>
      </div>
    </div>
    <div id="vehicleList"></div>
  </section>

  <!-- HISTORY -->
  <section id="tab-history" class="card" style="display:none">
    <div class="right" style="justify-content:space-between; margin-bottom:8px">
      <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
      <button class="btn secondary" onclick="clearHistory()">–ò–∑—á–∏—Å—Ç–∏</button>
    </div>
    <div id="historyList"></div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" class="card" style="display:none">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <div class="row">
      <div class="col-4">
        <label>–ß–∞—Å –∑–∞ –Ω–∞–ø–æ–º–Ω—è–Ω–∏—è</label>
        <input id="cfg_hour" type="time" value="09:00" />
      </div>
      <div class="col-8">
        <label>–ü—Ä–µ–¥–∏–∑–≤–µ—Å—Ç–∏–µ (–¥–Ω–∏)</label>
        <div class="chips">
          <label class="chip"><input id="cfg_d30" type="checkbox" checked/> 30</label>
          <label class="chip"><input id="cfg_d10" type="checkbox" checked/> 10</label>
          <label class="chip"><input id="cfg_d5" type="checkbox" checked/> 5</label>
          <label class="chip"><input id="cfg_d1" type="checkbox" checked/> 1</label>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="watermark">
      –ê–≤—Ç–æ—Ä: –°—Ç–∞–Ω–∏—Å–ª–∞–≤ –ö—Ä—ä—Å—Ç–µ–≤ ‚Ä¢ ‚úâÔ∏è <a class="link" href="mailto:stanislav90030@gmail.com">stanislav90030@gmail.com</a> ‚Ä¢ ‚òé +359 883 482 854
    </div>
  </section>

  <!-- VEHICLE EDITOR -->
  <section id="editor" class="card" style="display:none">
    <h3 id="editorTitle">–ú–ü–°</h3>
    <div class="row">
      <div class="col-4"><label>–ò–º–µ/–†–µ–≥. –Ω–æ–º–µ—Ä</label><input id="e_name" placeholder="–Ω–∞–ø—Ä. A1234BC –∏–ª–∏ BMW 320d"/></div>
      <div class="col-4"><label>–°–æ–±—Å—Ç–≤–µ–Ω–∏–∫ (–ø–æ –∏–∑–±–æ—Ä)</label><input id="e_owner" placeholder="–Ω–∞–ø—Ä. –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"/></div>
      <div class="col-4"><label>–¢–µ–∫—É—â –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂</label><input id="e_odometer" type="number" min="0" step="1" placeholder="–∫–º"/></div>

      <!-- –ì–û -->
      <div class="col-3"><label>–ì–û ‚Äì –Ω–∞—á–∞–ª–æ</label><input id="e_go_start" type="date"/></div>
      <div class="col-3">
        <label>–ì–û ‚Äì –≤–Ω–æ—Å–∫–∏</label>
        <select id="e_go_plan">
          <option value="1">1 –≤–Ω–æ—Å–∫–∞ (–≥–æ–¥–∏—à–Ω–æ)</option>
          <option value="2">2 –≤–Ω–æ—Å–∫–∏ (–Ω–∞ 6 –º.)</option>
          <option value="4">4 –≤–Ω–æ—Å–∫–∏ (–Ω–∞ 3 –º.)</option>
        </select>
      </div>
      <!-- –ì–¢–ü -->
      <div class="col-3"><label>–ì–¢–ü ‚Äì –¥–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–≥–ª–µ–¥–∞</label><input id="e_gtp" type="date"/></div>
      <!-- –í–∏–Ω–µ—Ç–∫–∞ -->
      <div class="col-3">
        <label>–í–∏–Ω–µ—Ç–∫–∞ ‚Äì —Ç–∏–ø</label>
        <select id="e_vignette_type">
          <option value="1">1 –º–µ—Å–µ—Ü</option>
          <option value="3">3 –º–µ—Å–µ—Ü–∞</option>
          <option value="12" selected>12 –º–µ—Å–µ—Ü–∞</option>
        </select>
      </div>
      <div class="col-3"><label>–í–∏–Ω–µ—Ç–∫–∞ ‚Äì –Ω–∞—á–∞–ª–æ</label><input id="e_vignette_start" type="date"/></div>

      <!-- –°–µ—Ä–≤–∏–∑–Ω–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ -->
      <div class="col-3"><label>–ú–∞—Å–ª–æ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_oil_km" type="number" min="0" step="500" placeholder="–Ω–∞–ø—Ä. 10000"/></div>
      <div class="col-3"><label>–ú–∞—Å–ª–æ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–º–µ—Å.)</label><input id="e_oil_mo" type="number" min="0" step="1" placeholder="–Ω–∞–ø—Ä. 12"/></div>
      <div class="col-3"><label>–§–∏–ª—Ç—ä—Ä –º–∞—Å–ª–µ–Ω ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_of_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ì–æ—Ä–∏–≤–µ–Ω —Ñ–∏–ª—Ç—ä—Ä ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_ff_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ü–æ–ª–µ–Ω–æ–≤/–∫–ª–∏–º–∞—Ç–∏–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–º–µ—Å.)</label><input id="e_cabin_mo" type="number" min="0" step="1"/></div>
      <div class="col-3"><label>–í—ä–∑–¥—É—à–µ–Ω —Ñ–∏–ª—Ç—ä—Ä ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_air_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ù–∞–∫–ª–∞–¥–∫–∏ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_pads_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_belt_km" type="number" min="0" step="1000"/></div>
      <div class="col-3"><label>–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≥–æ–¥.)</label><input id="e_belt_yr" type="number" min="0" step="1"/></div>
    </div>
    <div class="sep"></div>
    <div class="right">
      <button class="btn" onclick="saveVehicle()">–ó–∞–ø–∞–∑–∏</button>
      <button class="btn secondary" onclick="closeVehicleEditor()">–û—Ç–º–µ–Ω–∏</button>
      <button class="btn secondary" id="delBtn" style="display:none" onclick="deleteVehicle()">–ò–∑—Ç—Ä–∏–π</button>
    </div>
  </section>
</div>

<script>
/* ======== MODEL & STORAGE ======== */
const KEY='autonotify_servicebook_v1';
let db = { cfg:{hour:'09:00', d30:true, d10:true, d5:true, d1:true}, vehicles:[], history:[] };
let editId=null;

function load(){ try{ db = JSON.parse(localStorage.getItem(KEY)) || db; }catch{} applyCfgUI(); renderAll(); }
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }

/* ======== HELPERS ======== */
const addDays=(d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const addMonths=(d,m)=>{ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; };
const addYears=(d,y)=>{ const x=new Date(d); x.setFullYear(x.getFullYear()+y); return x; };
const fmt=(d)=> d? new Date(d).toLocaleDateString('bg-BG'):'‚Äî';
const daysLeft=(d)=> d? Math.ceil((new Date(d).setHours(0,0,0,0)-Date.now())/86400000): 9e9;
const statusClass=(n)=> n<=0?'bad':(n<=30?'warn':'ok');
const kmClass=(n)=> n<=0?'bad':(n<=1000?'warn':'ok');

/* ======== BUSINESS LOGIC ======== */
function tasksForVehicle(v){
  const out=[]; const today=new Date();
  if(v.goStart){
    const goEnd = addYears(v.goStart,1);
    out.push({veh:v.name, type:'–ì–û –∏–∑—Ç–∏—á–∞', date:goEnd});
    const plan = Number(v.goPlan||1);
    const instMonths = plan===1? [0] : (plan===2? [0,6] : [0,3,6,9]);
    instMonths.forEach(m=> out.push({veh:v.name, type:`–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞ ${m===0?1:(m/3+1)}`, date:addMonths(v.goStart,m)}) );
  }
  if(v.gtp){ out.push({veh:v.name, type:'–ì–¢–ü –∏–∑—Ç–∏—á–∞', date:addYears(v.gtp,1)}); }
  if(v.vigStart && v.vigType){ out.push({veh:v.name, type:'–í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞', date:addMonths(v.vigStart, Number(v.vigType))}); }

  const o = Number(v.odometer||0);
  const kmTask=(label,lastKm,intervalKm)=>{
    if(!intervalKm) return;
    const nextKm = (Number(lastKm||o)+Number(intervalKm));
    out.push({veh:v.name, type:label, kmDue:nextKm, kmLeft:nextKm-o});
  };
  kmTask('–°–º—è–Ω–∞ –º–∞—Å–ª–æ', v.oilLastKm??o, v.oilKm);
  kmTask('–ú–∞—Å–ª–µ–Ω —Ñ–∏–ª—Ç—ä—Ä', v.ofLastKm??o, v.ofKm);
  kmTask('–ì–æ—Ä–∏–≤–µ–Ω —Ñ–∏–ª—Ç—ä—Ä', v.ffLastKm??o, v.ffKm);
  kmTask('–í—ä–∑–¥—É—à–µ–Ω —Ñ–∏–ª—Ç—ä—Ä', v.airLastKm??o, v.airKm);
  kmTask('–ù–∞–∫–ª–∞–¥–∫–∏', v.padsLastKm??o, v.padsKm);
  kmTask('–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ (–∫–º)', v.beltLastKm??o, v.beltKm);
  if(v.beltYr){ out.push({veh:v.name, type:'–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ (–≥.)', date:addYears(v.beltStart||today, Number(v.beltYr))}); }
  return out;
}
function allTasks(){
  let arr=[]; db.vehicles.forEach(v=> arr=arr.concat(tasksForVehicle(v)));
  arr.forEach(t=>{ if(t.date){ t.days=daysLeft(t.date);} });
  arr.sort((a,b)=>{
    const ad=(a.date? a.days:9e9), bd=(b.date? b.days:9e9);
    if(ad!==bd) return ad-bd;
    const ak=(a.kmLeft??9e9), bk=(b.kmLeft??9e9);
    return ak-bk;
  });
  return arr;
}

/* ======== RENDER ======== */
function iconDot(type){
  if(type.startsWith('–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞') || type.startsWith('–ì–û ')) return 'dot-go';
  if(type.startsWith('–ì–¢–ü')) return 'dot-gtp';
  if(type.startsWith('–í–∏–Ω–µ—Ç–∫–∞')) return 'dot-vin';
  if(type.includes('–º–∞—Å–ª–æ')) return 'dot-oil';
  if(type.includes('—Ñ–∏–ª—Ç—ä—Ä')) return 'dot-filter';
  if(type.includes('–ù–∞–∫–ª–∞–¥–∫–∏')) return 'dot-brake';
  if(type.includes('–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω')) return 'dot-belt';
  return 'dot-go';
}
function renderDashboard(){
  const L=document.getElementById('todoList');
  const tasks = allTasks().slice(0,24);
  if(!tasks.length){ L.innerHTML='<div class="muted">–ù—è–º–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏ –∑–∞–¥–∞—á–∏. –î–æ–±–∞–≤–∏ –ú–ü–° –æ—Ç —Ä–∞–∑–¥–µ–ª ‚Äû–ú–ü–°‚Äú.</div>'; return; }
  L.innerHTML = tasks.map(t=>{
    if(t.date){
      const cls=statusClass(t.days);
      const value=(t.days<=0?'–∏–∑—Ç–µ–∫–ª–æ':t.days+' –¥–Ω–∏');
      return `<div class="item">
        <div>
          <div class="item-title"><span class="dot ${iconDot(t.type)}"></span>${t.type}</div>
          <div class="item-sub">${t.veh||'–ú–ü–°'} ‚Äî –¥–æ: ${fmt(t.date)}</div>
        </div>
        <div class="badge ${cls}">${value}</div>
      </div>`;
    } else {
      const left=t.kmLeft, cls=kmClass(left);
      const value=(left<=0?'–ø—Ä–æ—Å—Ä.':left+' –∫–º');
      return `<div class="item">
        <div>
          <div class="item-title"><span class="dot ${iconDot(t.type)}"></span>${t.type}</div>
          <div class="item-sub">${t.veh||'–ú–ü–°'} ‚Äî –Ω–∞: ${t.kmDue} –∫–º</div>
        </div>
        <div class="badge ${cls}">${value}</div>
      </div>`;
    }
  }).join('');
}
function renderVehicles(){
  const L=document.getElementById('vehicleList');
  if(!db.vehicles.length){ L.innerHTML='<div class="muted">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ú–ü–°.</div>'; return; }
  L.innerHTML = db.vehicles.map(v=>`
    <div class="item">
      <div>
        <div class="item-title">${v.name||'–ú–ü–°'} ${v.owner?('<span class="small muted">‚Ä¢ '+v.owner+'</span>'):''}</div>
        <div class="item-sub">–ì–û ${v.goStart?('–æ—Ç '+fmt(v.goStart)):'‚Äî'} ‚Ä¢ –ì–¢–ü ${v.gtp?fmt(v.gtp):'‚Äî'} ‚Ä¢ –í–∏–Ω–µ—Ç–∫–∞ ${v.vigStart?('–æ—Ç '+fmt(v.vigStart)+'/'+v.vigType+' –º.'):'‚Äî'} ‚Ä¢ –∫–º: ${v.odometer||0}</div>
      </div>
      <div class="right">
        <button class="btn secondary" onclick="editVehicle('${v.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
        <button class="btn secondary" onclick="downloadICS('${v.id}')">.ics</button>
      </div>
    </div>`).join('');
}
function renderHistory(){
  const L=document.getElementById('historyList');
  if(!db.history.length){ L.innerHTML='<div class="muted">–í—Å–µ –æ—â–µ –Ω—è–º–∞ –∑–∞–ø–∏—Å–∏.</div>'; return; }
  L.innerHTML = db.history.map(h=>`<div class="item">
    <div><b>${h.type}</b> ‚Ä¢ ${h.vehicle} ‚Äî ${fmt(h.date)} ‚Ä¢ ${h.odometer||0} –∫–º</div>
    <div class="small muted">${h.notes||''} ${h.cost?('‚Ä¢ '+h.cost+' –ª–≤.'):''}</div>
  </div>`).join('');
}
function renderAll(){ renderDashboard(); renderVehicles(); renderHistory(); }

/* ======== VEHICLE CRUD ======== */
function openVehicleEditor(){ editId=null; document.getElementById('editorTitle').textContent='–ù–æ–≤–æ –ú–ü–°';
  ['e_name','e_owner','e_odometer','e_go_start','e_go_plan','e_gtp','e_vignette_type','e_vignette_start','e_oil_km','e_oil_mo','e_of_km','e_ff_km','e_cabin_mo','e_air_km','e_pads_km','e_belt_km','e_belt_yr'].forEach(id=>{
    const el=document.getElementById(id); if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
  });
  document.getElementById('delBtn').style.display='none';
  document.getElementById('editor').style.display='block';
}
function closeVehicleEditor(){ document.getElementById('editor').style.display='none'; }
function editVehicle(id){
  const v=db.vehicles.find(x=>x.id===id); if(!v) return;
  editId=id; editorTitle.textContent='–†–µ–¥–∞–∫—Ü–∏—è';
  e_name.value=v.name||''; e_owner.value=v.owner||''; e_odometer.value=v.odometer||'';
  e_go_start.value=v.goStart||''; e_go_plan.value=String(v.goPlan||1);
  e_gtp.value=v.gtp||''; e_vignette_type.value=String(v.vigType||12); e_vignette_start.value=v.vigStart||'';
  e_oil_km.value=v.oilKm||''; e_oil_mo.value=v.oilMo||''; e_of_km.value=v.ofKm||''; e_ff_km.value=v.ffKm||'';
  e_cabin_mo.value=v.cabinMo||''; e_air_km.value=v.airKm||''; e_pads_km.value=v.padsKm||'';
  e_belt_km.value=v.beltKm||''; e_belt_yr.value=v.beltYr||'';
  delBtn.style.display='inline-flex'; editor.style.display='block';
}
function saveVehicle(){
  const v={
    id: editId || Math.random().toString(36).slice(2),
    name: e_name.value.trim(), owner: e_owner.value.trim(),
    odometer: Number(e_odometer.value||0),
    goStart: e_go_start.value||null, goPlan: Number(e_go_plan.value||1),
    gtp: e_gtp.value||null, vigType: Number(e_vignette_type.value||12), vigStart: e_vignette_start.value||null,
    oilKm: Number(e_oil_km.value||0), oilMo: Number(e_oil_mo.value||0),
    ofKm: Number(e_of_km.value||0), ffKm: Number(e_ff_km.value||0),
    cabinMo: Number(e_cabin_mo.value||0), airKm: Number(e_air_km.value||0),
    padsKm: Number(e_pads_km.value||0), beltKm: Number(e_belt_km.value||0), beltYr: Number(e_belt_yr.value||0)
  };
  if(editId){ db.vehicles=db.vehicles.map(x=>x.id===editId?v:x);} else { db.vehicles.push(v); }
  save(); closeVehicleEditor(); renderAll();
}
function deleteVehicle(){ if(!editId) return; db.vehicles=db.vehicles.filter(x=>x.id!==editId); save(); closeVehicleEditor(); renderAll(); }

/* ======== ICS EXPORT ======== */
function makeIcsForVehicle(v){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//AutoNotifyBG//ServiceBook//BG'];
  const addEvent=(title,date)=>{
    if(!date) return; const dt=new Date(date); dt.setHours(9,0,0,0);
    const stamp=dt.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
    const uid=Math.random().toString(36).slice(2)+'@autonotify.bg';
    lines.push('BEGIN:VEVENT','UID:'+uid,'DTSTAMP:'+stamp,'DTSTART:'+stamp,'SUMMARY:'+title+' ‚Ä¢ '+(v.name||'–ú–ü–°'));
    const cfg=db.cfg, alarms=[]; if(cfg.d30) alarms.push('-P30D'); if(cfg.d10) alarms.push('-P10D'); if(cfg.d5) alarms.push('-P5D'); if(cfg.d1) alarms.push('-P1D');
    alarms.forEach(a=>lines.push('BEGIN:VALARM','TRIGGER:'+a,'ACTION:DISPLAY','DESCRIPTION:–ù–∞–ø–æ–º–Ω—è–Ω–µ','END:VALARM'));
    lines.push('END:VEVENT');
  };
  if(v.goStart){ addEvent('–ì–û –∏–∑—Ç–∏—á–∞', addYears(v.goStart,1));
    const plan=Number(v.goPlan||1), inst=plan===1?[0]:(plan===2?[0,6]:[0,3,6,9]);
    inst.forEach((m,i)=> addEvent('–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞ '+(i+1), addMonths(v.goStart,m)) );
  }
  if(v.gtp) addEvent('–ì–¢–ü –∏–∑—Ç–∏—á–∞', addYears(v.gtp,1));
  if(v.vigStart && v.vigType) addEvent('–í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞', addMonths(v.vigStart, Number(v.vigType)));
  lines.push('END:VCALENDAR'); return lines.join('\r\n');
}
function download(name,content){ const a=document.createElement('a'); a.href='data:text/calendar;charset=utf-8,'+encodeURIComponent(content); a.download=name; a.click(); }
function downloadICS(id){ const v=db.vehicles.find(x=>x.id===id); if(!v) return; download((v.name||'mps')+'.ics', makeIcsForVehicle(v)); }
function exportAllICS(){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//AutoNotifyBG//ServiceBook//BG'];
  db.vehicles.forEach(v=>{ const p=makeIcsForVehicle(v).split('\r\n').filter(x=>!/^BEGIN:VCALENDAR|END:VCALENDAR$/.test(x)); lines.push(...p); });
  lines.push('END:VCALENDAR'); download('servicebook_all.ics', lines.join('\r\n'));
}

/* ======== SETTINGS ======== */
function applyCfgUI(){ cfg_hour.value=db.cfg.hour||'09:00'; cfg_d30.checked=!!db.cfg.d30; cfg_d10.checked=!!db.cfg.d10; cfg_d5.checked=!!db.cfg.d5; cfg_d1.checked=!!db.cfg.d1; }
['cfg_hour','cfg_d30','cfg_d10','cfg_d5','cfg_d1'].forEach(id=>{
  document.getElementById(id).addEventListener('change',()=>{ db.cfg.hour=cfg_hour.value; db.cfg.d30=cfg_d30.checked; db.cfg.d10=cfg_d10.checked; db.cfg.d5=cfg_d5.checked; db.cfg.d1=cfg_d1.checked; save(); });
});

/* ======== NAV ======== */
document.querySelectorAll('.nav .btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    const tab=b.dataset.tab;
    ['dashboard','vehicles','history','settings'].forEach(t=>{ document.getElementById('tab-'+t).style.display=(t===tab?'block':'none'); });
  });
});

/* ======== PWA INSTALL ======== */
let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; if(installBtn) installBtn.style.display='inline-flex'; });
if(installBtn){ installBtn.addEventListener('click', async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; }); }

/* BOOT */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(console.error)); }
load();
</script>
</body>
</html>
