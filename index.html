<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SK-carsinfo-BG ‚Äî –°–µ—Ä–≤–∏–∑–Ω–∞ –∫–Ω–∏–∂–∫–∞</title>
  <meta name="theme-color" content="#f3f6ff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f6ff; --text:#1b2a38; --muted:#5d6b7a;
      --card: rgba(255,255,255,.85); --border:#e3e9fb;
      --shadow: 0 10px 30px rgba(32,58,92,.10);
      --accent:#5ba7ff; --accent-hover:#3f90f3;
      --ok:#28c76f; --warn:#f9a826; --bad:#ff6b6b;
      --r:14px; --pad:12px; --gap:10px;
      --brand:#2d4c7a;
    }
    :root.dark{
      --bg:#0b1020; --text:#e8ecf1; --muted:#a8b3d1;
      --card: rgba(18,26,51,.88); --border:#1b274d;
      --shadow: 0 10px 30px rgba(0,0,0,.28);
      --accent:#5ba7ff; --accent-hover:#3f90f3;
      --ok:#9BE7A3; --warn:#FFD166; --bad:#FF8B8B;
      --brand:#b7c8e9;
    }

    *{box-sizing:border-box}
    html{ -webkit-text-size-adjust:100%; text-size-adjust:100% }
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family:"Nunito", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, #edf3ff 0%, transparent 60%),
        radial-gradient(1000px 600px at 90% 110%, #f7f0ff 0%, transparent 55%),
        linear-gradient(180deg, #f7fbff 0%, #f3f6ff 100%);
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:url('./bg-portrait-1080x1920.webp') center/cover no-repeat;
      filter: saturate(.7) contrast(.9);
    }
    @media (min-aspect-ratio:16/10){
      body::before{ background-image:url('./bg-landscape-1920x1080.webp'); }
    }
    body::after{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1000px 600px at 90% 110%, rgba(255,255,255,.55), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.55));
      mix-blend-mode: lighten;
    }
    :root.dark body::after{
      background:
       radial-gradient(1200px 700px at 15% -10%, rgba(0,0,0,.32), transparent 60%),
       radial-gradient(1000px 600px at 90% 110%, rgba(0,0,0,.32), transparent 55%),
       linear-gradient(180deg, rgba(0,0,0,.38), rgba(0,0,0,.38));
      mix-blend-mode: normal;
    }

    .app{max-width:1180px; margin:0 auto; padding:18px}

    /* ---- top header ---- */
    .top{
      display:grid;
      grid-template-columns: 1fr auto;
      grid-template-areas:
        "brand  wx"
        "nav    wx";
      gap:10px;
      align-items:start;
      margin-bottom:10px;
    }
    .brand{ grid-area: brand; font-weight:800; font-size:18px; line-height:1.1 }
    .nav{ grid-area: nav; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start }
    .today{ grid-area: wx; display:flex; flex-direction:column; align-items:flex-end; gap:6px }
    .wx{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:#ffffffcc; box-shadow: var(--shadow);
      font-size:16px; white-space:nowrap;
    }
    #todayText{ white-space:nowrap; color:var(--muted); font-weight:600 }
    @media (max-width: 520px){
      .brand{ font-size:16px }
      .wx{ font-size:15px }
    }

    .btn{
      padding:10px 14px; border-radius:999px;
      background: var(--accent); border:1px solid #cfe0ff; color:white; font-weight:700;
      box-shadow: 0 6px 18px rgba(91,167,255,.25); cursor:pointer
    }
    .btn:hover{ background:var(--accent-hover) }
    .btn.secondary{
      background: white; color:var(--text); border:1px solid var(--border);
      box-shadow: 0 6px 18px rgba(20,40,80,.06);
    }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--r);
      padding:var(--pad); margin-bottom:12px; box-shadow:var(--shadow); backdrop-filter: blur(4px);
    }

    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:var(--gap)}
    .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:#ffffff; color:var(--text); font-size:14px;
      box-shadow:0 1px 0 rgba(10,20,40,.02) inset;
    }
    input:focus,select:focus,textarea:focus{outline:none; border-color:#b9ccff; box-shadow:0 0 0 3px rgba(185,204,255,.35)}

    /* —Å—Ç–∞–±–∏–ª–Ω–∏ –ø–ª–æ—á–∫–∏ */
    #todoList{ display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:12px; }
    .item{
      display:grid; grid-template-columns:28px 1fr auto; align-items:center; gap:12px;
      padding:12px 14px; border:1px solid var(--border); border-radius:16px; background:#ffffffc4; box-shadow: var(--shadow);
    }
    .ico{ width:24px; height:24px; display:flex; align-items:center; justify-content:center; }
    .icon{ width:20px; height:20px; display:block; margin:0; vertical-align:middle; }
    .item-title{font-weight:700; line-height:1.2}
    .item-sub{font-size:12px; color:var(--muted); line-height:1.2}
    .badge{
      min-width:98px; text-align:center; padding:8px 10px; border-radius:10px; font-weight:700;
      background:#eef5ff; border:1px solid #d7e6ff; color:#2d4c7a;
    }
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{padding:3px 10px; border-radius:999px; border:1px solid var(--border); font-size:12px; background:#fff}
    .sep{height:1px; background:var(--border); opacity:.8; margin:8px 0}
    .right{display:flex; gap:8px; flex-wrap:wrap}
    .watermark{opacity:.75; font-size:12px; color:var(--muted)}
    a.link{color:#2a5ce6; text-decoration:none} a.link:hover{text-decoration:underline}

    /* sparkline */
    .spark{ width:100%; height:180px; overflow:visible; }
    .sp-axis{ stroke:#dfe6ff; stroke-width:1; }
    .sp-path{ fill:rgba(91,167,255,.15); stroke:#5ba7ff; stroke-width:2; }
    .sp-line{ fill:none; stroke:#5ba7ff; stroke-width:2; }
    .tl-label{ font-size:11px; fill:var(--muted); }
    .sp-wm{ fill:var(--muted); opacity:.08; font-weight:800; font-size:56px; pointer-events:none; }

    /* –µ–º–±–ª–µ–º–∏ */
    .brandmark{
     .brandlogo{
  width:34px; height:34px; object-fit:contain;
  border-radius:50%; background:linear-gradient(135deg,#eef4ff,#ffffff);
  border:1px solid var(--border); box-shadow:var(--shadow);
}
.brandlogo.big{ width:72px; height:72px; position:absolute; right:14px; top:14px; opacity:.9 }

    }
    .brandmark-big{
      position:absolute; right:14px; top:14px;
      width:72px; height:72px; border-radius:50%;
      background:linear-gradient(135deg,#eef4ff,#ffffff);
      border:1px solid var(--border);
      color:var(--brand); display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:22px; letter-spacing:.5px;
      opacity:.35; pointer-events:none; user-select:none;
      box-shadow: var(--shadow);
    }
    .card.logo-wrap{ position:relative; overflow:hidden; }
  </style>
</head>
<body>

<!-- SVG —Å–∏–º–≤–æ–ª–∏ -->
<svg width="0" height="0" style="position:absolute;opacity:0;pointer-events:none">
  <symbol id="i-go" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 5v5.2l4 2.3-.8 1.4L11 14V7h2Z"/></symbol>
  <symbol id="i-gtp" viewBox="0 0 24 24"><path fill="currentColor" d="M7 4h10l2 4v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8l2-4Zm0 4h10"/></symbol>
  <symbol id="i-vin" viewBox="0 0 24 24"><path fill="currentColor" d="M4 7h16v10H4z"/><path fill="currentColor" d="M6 5h12v2H6z"/></symbol>
  <symbol id="i-belt" viewBox="0 0 24 24"><path fill="currentColor" d="M4 12a8 8 0 1 1 16 0 8 8 0 0 1-16 0Zm3 0a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z"/></symbol>
  <symbol id="i-brake" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></symbol>
  <symbol id="i-cabin" viewBox="0 0 24 24"><path fill="currentColor" d="M4 7h16v10H4z"/><path fill="currentColor" d="M6 9h12v2H6zm0 4h12v2H6z"/></symbol>
</svg>

<div class="app">

  <!-- –ï–î–ò–ù–°–¢–í–ï–ù HEADER -->
  <div class="top">
    <div class="brand">üöó SK-carsinfo-BG ‚Äî –°–µ—Ä–≤–∏–∑–Ω–∞ –∫–Ω–∏–∂–∫–∞</div>

    <div class="nav">
      <button class="btn" data-tab="dashboard">–¢–∞–±–ª–æ</button>
      <button class="btn" data-tab="vehicles">–ú–ü–°</button>
      <button class="btn" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="btn secondary" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="btn secondary" id="themeBtn">–¢—ä–º–Ω–æ</button>
      <button class="btn secondary" id="installBtn" style="display:none">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π</button>
    </div>

    <div class="today">
      <div class="wx" id="wxBox">
        <span id="wxNow">‚Äî¬∞</span>
        <small id="wxNext">/ —É—Ç—Ä–µ ‚Äî¬∞</small>
        <input id="wxCity" placeholder="–í—ä–≤–µ–¥–∏ –≥—Ä–∞–¥" style="display:none"/>
      </div>
      <div id="todayText">–î–Ω–µ—Å: <span id="todayDate">‚Äî</span></div>
    </div>
  </div>

  <!-- –¢–ê–ë–õ–û -->
  <section id="tab-dashboard" class="card">
    <h3>–°–ª–µ–¥–≤–∞—â–∏ –∑–∞–¥–∞—á–∏</h3>
    <div id="todoList"></div>
    <div class="sep"></div>
    <div class="chips small">
      <div class="chip"><span class="ok">–∑–µ–ª–µ–Ω–æ</span> ‚Äî –≤—Å–∏—á–∫–æ –µ –Ω–∞—Ä–µ–¥</div>
      <div class="chip"><span class="warn">–∂—ä–ª—Ç–æ</span> ‚Äî &lt; 30 –¥–Ω–∏</div>
      <div class="chip"><span class="bad">—á–µ—Ä–≤–µ–Ω–æ</span> ‚Äî –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
    </div>
  </section>

  <!-- –ì–†–ê–§–ò–ö–ê -->
  <section class="card logo-wrap" id="spark-wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3>–ù–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ –ø–æ –º–µ—Å–µ—Ü–∏ <span id="spYear"></span></h3>
      <div class="small" style="color:var(--muted)">—Å—ä–±–∏—Ç–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –¥–∞—Ç–∞ –∑–∞ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –≥–æ–¥–∏–Ω–∞</div>
    </div>
    <svg id="spark" class="spark"></svg>
  </section>

  <!-- –ú–ü–° -->
  <section id="tab-vehicles" class="card" style="display:none">
    <div class="right" style="justify-content:space-between; margin-bottom:8px">
      <h3>–ú–æ–∏—Ç–µ –ú–ü–°</h3>
      <div class="right">
        <button class="btn" onclick="openVehicleEditor()">–î–æ–±–∞–≤–∏ –ú–ü–°</button>
        <button class="btn secondary" onclick="exportAllICS()">–ï–∫—Å–ø–æ—Ä—Ç .ics</button>
      </div>
    </div>
    <div id="vehicleList"></div>
  </section>

  <!-- –ò–°–¢–û–†–ò–Ø -->
  <section id="tab-history" class="card" style="display:none">
    <div class="right" style="justify-content:space-between; margin-bottom:8px">
      <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
      <button class="btn secondary" onclick="clearHistory()">–ò–∑—á–∏—Å—Ç–∏</button>
    </div>
    <div id="historyList"></div>
  </section>

  <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
  <section id="tab-settings" class="card" style="display:none">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <div class="row">
      <div class="col-4">
        <label>–ß–∞—Å –∑–∞ –Ω–∞–ø–æ–º–Ω—è–Ω–∏—è</label>
        <input id="cfg_hour" type="time" value="09:00" />
      </div>
      <div class="col-4">
        <label>–ü—Ä–µ–¥–∏–∑–≤–µ—Å—Ç–∏–µ (–¥–Ω–∏)</label>
        <div class="chips">
          <label class="chip"><input id="cfg_d30" type="checkbox" checked/> 30</label>
          <label class="chip"><input id="cfg_d10" type="checkbox" checked/> 10</label>
          <label class="chip"><input id="cfg_d5"  type="checkbox" checked/> 5</label>
          <label class="chip"><input id="cfg_d1"  type="checkbox" checked/> 1</label>
        </div>
      </div>
      <div class="col-4">
        <label>–ì–æ–¥–∏–Ω–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ç–∞</label>
        <select id="cfg_timeline_year"></select>
      </div>
    </div>
    <div class="sep"></div>
    <div class="watermark">
      –ê–≤—Ç–æ—Ä: –°—Ç–∞–Ω–∏—Å–ª–∞–≤ –ö—Ä—ä—Å—Ç–µ–≤ ‚Ä¢ ‚úâÔ∏è <a class="link" href="mailto:stanislav90030@gmail.com">stanislav90030@gmail.com</a> ‚Ä¢ ‚òé +359 883 482 854
    </div>
  </section>

  <!-- –ï–î–ò–¢–û–† -->
  <section id="editor" class="card logo-wrap" style="display:none">
    <h3 id="editorTitle">–ú–ü–°</h3>
    <div id="logoPreview" class="brandmark-big">SK</div>
    <div class="row">
      <div class="col-3"><label>–ú–∞—Ä–∫–∞</label><select id="e_make"></select></div>
      <div class="col-3"><label>–ú–æ–¥–µ–ª</label><select id="e_model"></select></div>
      <div class="col-3"><label>–†–µ–≥. –Ω–æ–º–µ—Ä / –ò–º–µ</label><input id="e_name" placeholder="–Ω–∞–ø—Ä. A1234BC"/></div>
      <div class="col-3"><label>–°–æ–±—Å—Ç–≤–µ–Ω–∏–∫ (–ø–æ –∏–∑–±–æ—Ä)</label><input id="e_owner" placeholder="–Ω–∞–ø—Ä. –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"/></div>

      <div class="col-3"><label>–¢–µ–∫—É—â –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂</label><input id="e_odometer" type="number" min="0" step="1" placeholder="–∫–º"/></div>

      <div class="col-3"><label>–ì–û ‚Äì –Ω–∞—á–∞–ª–æ</label><input id="e_go_start" type="date"/></div>
      <div class="col-3">
        <label>–ì–û ‚Äì –≤–Ω–æ—Å–∫–∏</label>
        <select id="e_go_plan">
          <option value="1">1 –≤–Ω–æ—Å–∫–∞ (–≥–æ–¥–∏—à–Ω–æ)</option>
          <option value="2">2 –≤–Ω–æ—Å–∫–∏ (–Ω–∞ 6 –º.)</option>
          <option value="4">4 –≤–Ω–æ—Å–∫–∏ (–Ω–∞ 3 –º.)</option>
        </select>
      </div>
      <div class="col-3"><label>–ì–¢–ü ‚Äì –¥–∞—Ç–∞</label><input id="e_gtp" type="date"/></div>

      <div class="col-3">
        <label>–í–∏–Ω–µ—Ç–∫–∞ ‚Äì —Ç–∏–ø</label>
        <select id="e_vignette_type">
          <option value="1">1 –º–µ—Å–µ—Ü</option>
          <option value="3">3 –º–µ—Å–µ—Ü–∞</option>
          <option value="12" selected>12 –º–µ—Å–µ—Ü–∞</option>
        </select>
      </div>
      <div class="col-3"><label>–í–∏–Ω–µ—Ç–∫–∞ ‚Äì –Ω–∞—á–∞–ª–æ</label><input id="e_vignette_start" type="date"/></div>

      <div class="col-3"><label>–ü–æ–ª–µ–Ω–æ–≤/–∫–ª–∏–º–∞—Ç–∏–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–º–µ—Å.)</label><input id="e_cabin_mo" type="number" min="0" step="1"/></div>
      <div class="col-3"><label>–ù–∞–∫–ª–∞–¥–∫–∏ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_pads_km" type="number" min="0" step="500"/></div>
      <div class="col-3"><label>–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–∫–º)</label><input id="e_belt_km" type="number" min="0" step="1000"/></div>
      <div class="col-3"><label>–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ ‚Äì –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≥–æ–¥.)</label><input id="e_belt_yr" type="number" min="0" step="1"/></div>
    </div>
    <div class="sep"></div>
    <div class="right">
      <button class="btn" onclick="saveVehicle()">–ó–∞–ø–∞–∑–∏</button>
      <button class="btn secondary" onclick="closeVehicleEditor()">–û—Ç–º–µ–Ω–∏</button>
      <button class="btn secondary" id="delBtn" style="display:none" onclick="deleteVehicle()">–ò–∑—Ç—Ä–∏–π</button>
    </div>
  </section>

  <div class="footer watermark">
    Stanislav Krastev ‚Äî <a class="link" href="mailto:stanislav90030@gmail.com">stanislav90030@gmail.com</a> ‚Äî +359 883 482 854
  </div>
</div>

<script>
/* ===== model & storage ===== */
const KEY='sk_carsinfo_servicebook_v2';
let db = { cfg:{hour:'09:00', d30:true, d10:true, d5:true, d1:true, timelineYear:'current'},
           vehicles:[], history:[], wx:{city:'', lat:null, lon:null} };
let editId=null;
const $ = (id) => document.getElementById(id);

/* make/model dictionary */
const MAKES = {
  'Volkswagen':['Golf','Passat','Tiguan','Polo','Touareg'],
  'BMW':['3 Series','5 Series','X3','X5','1 Series'],
  'Mercedes-Benz':['C-Class','E-Class','GLC','A-Class','GLE'],
  'Audi':['A3','A4','A6','Q3','Q5'],
  'Toyota':['Corolla','Camry','RAV4','Yaris','Auris'],
  'Honda':['Civic','Accord','CR-V','Jazz'],
  'Ford':['Focus','Mondeo','Kuga','Fiesta'],
  'Opel':['Astra','Insignia','Corsa','Zafira'],
  '≈†koda':['Octavia','Superb','Fabia','Kodiaq'],
  'Renault':['Megane','Clio','Captur','Laguna'],
  'Peugeot':['308','3008','508','208'],
  'Citro√´n':['C3','C4','C5 Aircross'],
  'Nissan':['Qashqai','X-Trail','Micra'],
  'Hyundai':['i30','Tucson','i20','Santa Fe'],
  'Kia':['Ceed','Sportage','Rio'],
  'Mazda':['3','6','CX-5','CX-3'],
  '–î—Ä—É–≥–æ':['(—Å–≤–æ–±–æ–¥–µ–Ω –º–æ–¥–µ–ª)']
};
const MAKE_LIST = Object.keys(MAKES);

/* storage */
function load(){ try{ db = JSON.parse(localStorage.getItem(KEY)) || db; }catch{} applyCfgUI(); }
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }

/* helpers */
const addMonths=(d,m)=>{ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; };
const addYears=(d,y)=>{ const x=new Date(d); x.setFullYear(x.getFullYear()+y); return x; };
const fmt=(d)=> d? new Date(d).toLocaleDateString('bg-BG'):'‚Äî';
const daysLeft=(d)=> d? Math.ceil((new Date(d).setHours(0,0,0,0)-Date.now())/86400000): 9e9;
const statusClass=(n)=> n<=0?'bad':(n<=30?'warn':'ok');
function brandInitials(make){ return (make||'').split(/[ -]/).map(w=>w[0]).join('').slice(0,3).toUpperCase(); }
function slug(str){
  return (str||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')   // –º–∞—Ö–∞ –¥–∏–∞–∫—Ä–∏—Ç–∏–∫–∞ (≈†koda -> Skoda)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,'-')                        // –≤—Å–∏—á–∫–æ –¥—Ä—É–≥–æ -> —Ç–∏—Ä–µ
    .replace(/^-+|-+$/g,'');                           // —á–∏—Å—Ç–∏ —Ç–∏—Ä–µ—Ç–∞ –≤ –∫—Ä–∞—è
}

// –ü—ä—Ä–≤–æ –ø—Ä–æ–±–≤–∞ SVG, –ø–æ—Å–ª–µ PNG; –∞–∫–æ –∏ –¥–≤–µ—Ç–µ –ª–∏–ø—Å–≤–∞—Ç ‚Äî –º–∞—Ö–∞ <img> –∏ –æ—Å—Ç–∞–≤—è –∏–Ω–∏—Ü–∏–∞–ª–∏—Ç–µ:
function logoImgHTML(make, cls=''){
  const s = slug(make);
  const svg = `logos/${s}.svg`;
  const png = `logos/${s}.png`;
  return `<img class="brandlogo ${cls}" src="${svg}" alt="${make}"
    onerror="
      this.onerror=null;
      this.src='${png}';
      this.onerror=function(){ this.remove(); };
    ">`;
}

// –ó–∞—Ä–µ–∂–¥–∞–º–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å –º–∞—Ä–∫–∏/–º–æ–¥–µ–ª–∏ –æ—Ç data/makes.json
let MAKES = {};
let MAKE_LIST = [];
async function loadMakes(){
  try{
    const res = await fetch('data/makes.json');
    MAKES = await res.json();
    MAKE_LIST = Object.keys(MAKES);
  }catch(e){
    console.warn('makes.json –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω ‚Äî fallback', e);
    MAKES = {"–î—Ä—É–≥–æ":["(—Å–≤–æ–±–æ–¥–µ–Ω –º–æ–¥–µ–ª)"]};
    MAKE_LIST = Object.keys(MAKES);
  }
}

/* business */
function tasksForVehicle(v){
  const out=[];
  if(v.goStart){
    out.push({veh:labelVeh(v), type:'–ì–û –∏–∑—Ç–∏—á–∞', date:addYears(v.goStart,1)});
    const plan=Number(v.goPlan||1), inst=plan===1?[0]:(plan===2?[0,6]:[0,3,6,9]);
    inst.forEach((m,i)=> out.push({veh:labelVeh(v), type:`–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞ ${i+1}`, date:addMonths(v.goStart,m)}));
  }
  if(v.gtp){ out.push({veh:labelVeh(v), type:'–ì–¢–ü –∏–∑—Ç–∏—á–∞', date:addYears(v.gtp,1)}); }
  if(v.vigStart && v.vigType){ out.push({veh:labelVeh(v), type:'–í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞', date:addMonths(v.vigStart, Number(v.vigType))}); }
  if(v.cabinMo){ out.push({veh:labelVeh(v), type:'–ü–æ–ª–µ–Ω–æ–≤/–∫–ª–∏–º–∞—Ç–∏–∫', date:addMonths(new Date(), Number(v.cabinMo))}); }
  if(v.padsKm && v.odometer) out.push({veh:labelVeh(v), type:'–ù–∞–∫–ª–∞–¥–∫–∏', kmDue:Number(v.odometer)+Number(v.padsKm), kmLeft:Number(v.padsKm)});
  if(v.beltKm && v.odometer) out.push({veh:labelVeh(v), type:'–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ (–∫–º)', kmDue:Number(v.odometer)+Number(v.beltKm), kmLeft:Number(v.beltKm)});
  if(v.beltYr) out.push({veh:labelVeh(v), type:'–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω —Ä–µ–º—ä–∫ (–≥.)', date:addYears(new Date(), Number(v.beltYr))});
  return out;
}
function labelVeh(v){
  const mm = [v.make, v.model].filter(Boolean).join(' ');
  return mm ? `${mm} (${v.name||'–ú–ü–°'})` : (v.name||'–ú–ü–°');
}
function allTasks(){
  let arr=[]; db.vehicles.forEach(v=> arr=arr.concat(tasksForVehicle(v)));
  arr.forEach(t=>{ if(t.date){ t.days=daysLeft(t.date); }});
  arr.sort((a,b)=>{ const ad=(a.date?a.days:9e9), bd=(b.date?b.days:9e9); if(ad!==bd) return ad-bd; return (a.kmLeft??9e9)-(b.kmLeft??9e9); });
  return arr;
}

/* today + weather */
function renderToday(){
  const d = new Date().toLocaleDateString('bg-BG');
  const el = document.getElementById('todayDate');
  if(el) el.textContent = d + ' –≥.';
}
async function updateWeather(){
  try{
    let lat=db.wx.lat, lon=db.wx.lon;
    if(!lat || !lon){
      await new Promise((res)=>navigator.geolocation?.getCurrentPosition(p=>{ lat=p.coords.latitude; lon=p.coords.longitude; db.wx.lat=lat; db.wx.lon=lon; save(); res(); }, ()=>res(), {timeout:2000}));
    }
    if(!lat || !lon){
      $('wxCity').style.display='inline-block';
      $('wxCity').addEventListener('change', async ()=>{
        const city=$('wxCity').value.trim(); if(!city) return;
        const g = await (await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=bg&format=json`)).json();
        if(g.results && g.results[0]){ db.wx.city=city; db.wx.lat=g.results[0].latitude; db.wx.lon=g.results[0].longitude; save(); updateWeather(); }
      }, {once:true});
      return;
    }
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto`;
    const data = await (await fetch(url)).json();
    const nowT = Math.round(data?.current?.temperature_2m ?? NaN);
    const tMin = Math.round(data?.daily?.temperature_2m_min?.[1] ?? NaN);
    const tMax = Math.round(data?.daily?.temperature_2m_max?.[1] ?? NaN);
    $('wxNow').textContent = (isFinite(nowT)? `${nowT}¬∞` : '‚Äî¬∞');
    $('wxNext').textContent = (isFinite(tMin)&&isFinite(tMax)? `/ —É—Ç—Ä–µ ${tMin}‚Ä¶${tMax}¬∞` : '/ —É—Ç—Ä–µ ‚Äî¬∞');
  }catch(e){ console.warn('weather', e); }
}

/* dashboard */
function iconId(type){
  if(type.startsWith('–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞') || type.startsWith('–ì–û ')) return 'i-go';
  if(type.startsWith('–ì–¢–ü')) return 'i-gtp';
  if(type.startsWith('–í–∏–Ω–µ—Ç–∫–∞')) return 'i-vin';
  if(type.includes('–ê–Ω–≥—Ä–µ–Ω–∞–∂–µ–Ω')) return 'i-belt';
  if(type.includes('–ù–∞–∫–ª–∞–¥–∫–∏')) return 'i-brake';
  if(type.includes('–ü–æ–ª–µ–Ω–æ–≤')) return 'i-cabin';
  return 'i-go';
}
function renderDashboard(){
  const L=$('todoList');
  const tasks=allTasks().slice(0,24);
  if(!tasks.length){ L.innerHTML='<div class="item" style="grid-template-columns:1fr;justify-content:center">–ù—è–º–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏ –∑–∞–¥–∞—á–∏. –î–æ–±–∞–≤–∏ –ú–ü–° –æ—Ç —Ä–∞–∑–¥–µ–ª ‚Äû–ú–ü–°‚Äú.</div>'; return; }
  L.innerHTML = tasks.map(t=>{
    if(t.date){
      const cls=statusClass(t.days), value=(t.days<=0?'–∏–∑—Ç–µ–∫–ª–æ':t.days+' –¥–Ω–∏');
      return `<div class="item">
        <div class="ico"><svg class="icon"><use href="#${iconId(t.type)}"/></svg></div>
        <div class="text">
          <div class="item-title">${t.type}</div>
          <div class="item-sub">${t.veh||'–ú–ü–°'} ‚Äî –¥–æ: ${fmt(t.date)}</div>
        </div>
        <div class="badge ${cls}">${value}</div>
      </div>`;
    }else{
      const left=t.kmLeft, cls=(left<=0?'bad':(left<=1000?'warn':'ok')), value=(left<=0?'–ø—Ä–æ—Å—Ä.':left+' –∫–º');
      return `<div class="item">
        <div class="ico"><svg class="icon"><use href="#${iconId(t.type)}"/></svg></div>
        <div class="text">
          <div class="item-title">${t.type}</div>
          <div class="item-sub">${t.veh||'–ú–ü–°'} ‚Äî –Ω–∞: ${t.kmDue} –∫–º</div>
        </div>
        <div class="badge ${cls}">${value}</div>
      </div>`;
    }
  }).join('');
}

/* vehicles & history */
function renderVehicles(){
  const L=$('vehicleList');
  if(!db.vehicles.length){ L.innerHTML='<div class="item" style="grid-template-columns:1fr;justify-content:center">–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ –ú–ü–°.</div>'; return; }
  L.innerHTML = db.vehicles.map(v=>`
    <div class="item logo-wrap" style="grid-template-columns:34px 1fr auto">
  <div class="brandmark" style="position:relative">
    ${logoImgHTML(v.make||'')}
    <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
      ${brandInitials(v.make||'')}
    </div>
  </div>
  ...
  <div class="brandmark-big">
    ${logoImgHTML(v.make||'', 'big')}
    <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
      ${brandInitials(v.make||'')}
    </div>
  </div>
</div>

function renderHistory(){
  const L=$('historyList');
  if(!db.history.length){ L.innerHTML='<div class="item" style="grid-template-columns:1fr;justify-content:center">–í—Å–µ –æ—â–µ –Ω—è–º–∞ –∑–∞–ø–∏—Å–∏.</div>'; return; }
  L.innerHTML = db.history.map(h=>`<div class="item" style="grid-template-columns:1fr auto">
    <div><b>${h.type}</b> ‚Ä¢ ${h.vehicle} ‚Äî ${fmt(h.date)} ‚Ä¢ ${h.odometer||0} –∫–º</div>
    <div class="item-sub">${h.notes||''} ${h.cost?('‚Ä¢ '+h.cost+' –ª–≤.'):''}</div>
  </div>`).join('');
}

/* SPARKLINE */
function sparkYearValue(){
  const sel = db.cfg.timelineYear;
  return (sel==='current') ? new Date().getFullYear() : Number(sel)||new Date().getFullYear();
}
function datedTasks(){ return allTasks().filter(t => !!t.date); }
function monthlyBuckets(year){
  const buckets = Array(12).fill(0);
  datedTasks().forEach(t=>{
    const d = new Date(t.date); d.setFullYear(year);
    buckets[d.getMonth()]++;
  });
  return buckets;
}
function buildSmoothPath(points){
  if(points.length<2) return '';
  let d = `M ${points[0].x} ${points[0].y}`;
  for(let i=0;i<points.length-1;i++){
    const p0=points[i], p1=points[i+1];
    const mx=(p0.x+p1.x)/2, my=(p0.y+p1.y)/2;
    d += ` Q ${p0.x} ${p0.y} ${mx} ${my}`;
    if(i<points.length-2){
      const p2=points[i+2], mx2=(p1.x+p2.x)/2, my2=(p1.y+p2.y)/2;
      d += ` T ${mx2} ${my2}`;
    }else{
      d += ` T ${p1.x} ${p1.y}`;
    }
  }
  return d;
}
function renderSpark(){
  const year = sparkYearValue();
  const svg  = $('spark'); if(!svg) return;
  const w    = svg.clientWidth || svg.parentElement.clientWidth;
  const h    = svg.clientHeight || 180;
  const padL = 28, padR = 36, padT = 16, padB = 32;
  $('spYear').textContent = year;

  const values = monthlyBuckets(year);
  const maxVal = Math.max(1, ...values);

  const stepX  = (w - padL - padR) / 12;
  const pts = values.map((v,i)=>{
    const x = padL + (i + 0.5) * stepX;
    const y = padT + (h - padT - padB) * (1 - v/maxVal);
    return {x,y};
  });

  const ns='http://www.w3.org/2000/svg';
  svg.innerHTML='';

  // –≤–æ–¥–µ–Ω –∑–Ω–∞–∫
  const wm=document.createElementNS(ns,'text');
  wm.setAttribute('x', w/2);
  wm.setAttribute('y', padT + (h - padT - padB)/2 + 12);
  wm.setAttribute('text-anchor','middle');
  wm.setAttribute('class','sp-wm');
  const fs = Math.max(22, Math.min(56, 0.12 * w));
  wm.setAttribute('style', `font-size:${fs}px`);
  wm.textContent='SK-carsinfo-BG';
  svg.appendChild(wm);

  // –æ—Å X + –µ—Ç–∏–∫–µ—Ç–∏
  const axis=document.createElementNS(ns,'line');
  axis.setAttribute('x1',padL); axis.setAttribute('x2',w-padR);
  axis.setAttribute('y1',h-padB); axis.setAttribute('y2',h-padB);
  axis.setAttribute('class','sp-axis'); svg.appendChild(axis);

  for(let m=0;m<12;m++){
    const x=padL + (m + 0.5) * stepX;
    const tick=document.createElementNS(ns,'line');
    tick.setAttribute('x1',x); tick.setAttribute('x2',x);
    tick.setAttribute('y1',h-padB); tick.setAttribute('y2',h-padB+6);
    tick.setAttribute('class','sp-axis'); tick.style.opacity=.5; svg.appendChild(tick);

    const lbl=document.createElementNS(ns,'text');
    lbl.setAttribute('x', x); lbl.setAttribute('y', h-10);
    lbl.setAttribute('class','tl-label');
    lbl.setAttribute('text-anchor', 'middle');
    lbl.textContent = String(m+1).padStart(2,'0');   // 01..12
    svg.appendChild(lbl);
  }

  const d = buildSmoothPath(pts);
  if(d){
    const area=document.createElementNS(ns,'path');
    const areaD = d + ` L ${pts[pts.length-1].x} ${h-padB} L ${pts[0].x} ${h-padB} Z`;
    area.setAttribute('d',areaD); area.setAttribute('class','sp-path'); svg.appendChild(area);
    const line=document.createElementNS(ns,'path');
    line.setAttribute('d',d); line.setAttribute('class','sp-line'); svg.appendChild(line);
  }
}

/* CRUD / ICS */
function fillMakeModel(){
  $('e_make').innerHTML = MAKE_LIST.map(m=>`<option value="${m}">${m}</option>`).join('');
  $('e_model').innerHTML = MAKES[MAKE_LIST[0]].map(x=>`<option value="${x}">${x}</option>`).join('');
  $('e_make').addEventListener('change', ()=>{
    const mk=$('e_make').value;
    const models = MAKES[mk] || ['(—Å–≤–æ–±–æ–¥–µ–Ω –º–æ–¥–µ–ª)'];
    $('e_model').innerHTML = models.map(x=>`<option value="${x}">${x}</option>`).join('');
    updateLogoPreview();
  });
}
function updateLogoPreview(){
  const mk = $('e_make')?.value || 'SK';
  $('logoPreview').textContent = brandInitials(mk);
}
function openVehicleEditor(){
  editId = null; $('editorTitle').textContent = '–ù–æ–≤–æ –ú–ü–°';
  ['e_make','e_model','e_name','e_owner','e_odometer','e_go_start','e_go_plan','e_gtp','e_vignette_type','e_vignette_start','e_cabin_mo','e_pads_km','e_belt_km','e_belt_yr']
    .forEach(id=>{ const el=$(id); if(!el) return; if(el.tagName==='SELECT'){ el.selectedIndex=0; } else { el.value=''; }});
  $('delBtn').style.display = 'none';
  $('editor').style.display = 'block';
  updateLogoPreview();
}
function closeVehicleEditor(){ $('editor').style.display='none'; }
function editVehicle(id){
  const v=db.vehicles.find(x=>x.id===id); if(!v) return;
  editId=id; $('editorTitle').textContent='–†–µ–¥–∞–∫—Ü–∏—è';
  $('e_make').value = v.make || MAKE_LIST[0];
  $('e_model').innerHTML = (MAKES[$('e_make').value]||['(—Å–≤–æ–±–æ–¥–µ–Ω –º–æ–¥–µ–ª)']).map(x=>`<option value="${x}" ${x===v.model?'selected':''}>${x}</option>`).join('');
  $('e_name').value=v.name||''; $('e_owner').value=v.owner||'';
  $('e_odometer').value=v.odometer||'';
  $('e_go_start').value=v.goStart||''; $('e_go_plan').value=String(v.goPlan||1);
  $('e_gtp').value=v.gtp||'';
  $('e_vignette_type').value=String(v.vigType||12);
  $('e_vignette_start').value=v.vigStart||'';
  $('e_cabin_mo').value=v.cabinMo||'';
  $('e_pads_km').value=v.padsKm||'';
  $('e_belt_km').value=v.beltKm||'';
  $('e_belt_yr').value=v.beltYr||'';
  $('delBtn').style.display='inline-flex'; $('editor').style.display='block';
  updateLogoPreview();
}
function saveVehicle(){
  const v={
    id: editId || Math.random().toString(36).slice(2),
    make:$('e_make').value, model:$('e_model').value,
    name:$('e_name').value.trim(), owner:$('e_owner').value.trim(), odometer:Number($('e_odometer').value||0),
    goStart:$('e_go_start').value||null, goPlan:Number($('e_go_plan').value||1),
    gtp:$('e_gtp').value||null, vigType:Number($('e_vignette_type').value||12), vigStart:$('e_vignette_start').value||null,
    cabinMo:Number($('e_cabin_mo').value||0), padsKm:Number($('e_pads_km').value||0),
    beltKm:Number($('e_belt_km').value||0), beltYr:Number($('e_belt_yr').value||0)
  };
  if(editId){ db.vehicles=db.vehicles.map(x=>x.id===editId?v:x);} else { db.vehicles.push(v); }
  save(); closeVehicleEditor(); renderAll();
}
function deleteVehicle(){ if(!editId) return; db.vehicles=db.vehicles.filter(x=>x.id!==editId); save(); closeVehicleEditor(); renderAll(); }

function clearHistory(){ db.history=[]; save(); renderHistory(); }

/* ics helpers */
function makeIcsForVehicle(v){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//SK-carsinfo-BG//ServiceBook//BG'];
  const addEvent=(title,date)=>{
    if(!date) return; const dt=new Date(date); dt.setHours(9,0,0,0);
    const stamp=dt.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
    const uid=Math.random().toString(36).slice(2)+'@sk-carsinfo.bg';
    lines.push('BEGIN:VEVENT','UID:'+uid,'DTSTAMP:'+stamp,'DTSTART:'+stamp,'SUMMARY:'+title+' ‚Ä¢ '+(v.name||'–ú–ü–°'));
    const c=db.cfg, a=[]; if(c.d30)a.push('-P30D'); if(c.d10)a.push('-P10D'); if(c.d5)a.push('-P5D'); if(c.d1)a.push('-P1D');
    a.forEach(x=>lines.push('BEGIN:VALARM','TRIGGER:'+x,'ACTION:DISPLAY','DESCRIPTION:–ù–∞–ø–æ–º–Ω—è–Ω–µ','END:VALARM'));
    lines.push('END:VEVENT');
  };
  if(v.goStart){ addEvent('–ì–û –∏–∑—Ç–∏—á–∞', addYears(v.goStart,1));
    (Number(v.goPlan||1)===1?[0]:(Number(v.goPlan||1)===2?[0,6]:[0,3,6,9]))
      .forEach((m,i)=> addEvent('–ì–û ‚Äì –≤–Ω–æ—Å–∫–∞ '+(i+1), addMonths(v.goStart,m)));
  }
  if(v.gtp) addEvent('–ì–¢–ü –∏–∑—Ç–∏—á–∞', addYears(v.gtp,1));
  if(v.vigStart&&v.vigType) addEvent('–í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞', addMonths(v.vigStart, Number(v.vigType)));
  lines.push('END:VCALENDAR'); return lines.join('\r\n');
}
function download(name,content){ const a=document.createElement('a'); a.href='data:text/calendar;charset=utf-8,'+encodeURIComponent(content); a.download=name; a.click(); }
function downloadICS(id){ const v=db.vehicles.find(x=>x.id===id); if(!v) return; download((v.name||'mps')+'.ics', makeIcsForVehicle(v)); }
function exportAllICS(){
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//SK-carsinfo-BG//ServiceBook//BG'];
  db.vehicles.forEach(v=>{ const p=makeIcsForVehicle(v).split('\r\n').filter(x=>!/^BEGIN:VCALENDAR|END:VCALENDAR$/.test(x)); lines.push(...p); });
  lines.push('END:VCALENDAR'); download('servicebook_all.ics', lines.join('\r\n'));
}

/* settings */
function applyCfgUI(){
  $('cfg_hour').value = db.cfg.hour || '09:00';
  $('cfg_d30').checked = !!db.cfg.d30; $('cfg_d10').checked = !!db.cfg.d10; $('cfg_d5').checked  = !!db.cfg.d5; $('cfg_d1').checked  = !!db.cfg.d1;
  const nowY = new Date().getFullYear();
  const opts = ['current', nowY-1, nowY, nowY+1, nowY+2];
  $('cfg_timeline_year').innerHTML = opts.map(v =>
    `<option value="${v}" ${String(v)===String(db.cfg.timelineYear)?'selected':''}>${v==='current'?'–¢–µ–∫—É—â–∞':v}</option>`
  ).join('');
}
;['cfg_hour','cfg_d30','cfg_d10','cfg_d5','cfg_d1','cfg_timeline_year'].forEach(id=>{
  document.addEventListener('change', (e)=> {
    if(e.target && e.target.id===id){
      db.cfg.hour = $('cfg_hour').value;
      db.cfg.d30  = $('cfg_d30').checked;
      db.cfg.d10  = $('cfg_d10').checked;
      db.cfg.d5   = $('cfg_d5').checked;
      db.cfg.d1   = $('cfg_d1').checked;
      db.cfg.timelineYear = $('cfg_timeline_year').value;
      save(); renderSpark();
    }
  });
});

/* nav */
document.querySelectorAll('.nav .btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    const tab = b.dataset.tab;
    ['dashboard','vehicles','history','settings'].forEach(t=>{
      const el = $('tab-'+t);
      if(el) el.style.display = (t===tab ? 'block' : 'none');
    });
  });
});

/* theme toggle */
function applyTheme(){
  const mode = localStorage.getItem('theme') || 'light';
  document.documentElement.classList.toggle('dark', mode==='dark');
  $('themeBtn').textContent = (mode==='dark' ? '–°–≤–µ—Ç–ª–æ' : '–¢—ä–º–Ω–æ');
}
$('themeBtn').addEventListener('click', ()=>{
  const mode = (localStorage.getItem('theme') || 'light') === 'light' ? 'dark' : 'light';
  localStorage.setItem('theme', mode); applyTheme();
});

/* weather polling */
setInterval(updateWeather, 30*60*1000);

/* pwa install */
let deferredPrompt=null; const installBtn=$('installBtn');
window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; if(installBtn) installBtn.style.display='inline-flex'; });
if(installBtn){ installBtn.addEventListener('click', async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; }); }

/* render all */
function renderAll(){ renderToday(); renderDashboard(); renderVehicles(); renderHistory(); renderSpark(); }

/* SW v19 */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw-v20.js');
  });
}

applyTheme();
fillMakeModel();
load();
renderAll();
updateWeather();
window.addEventListener('resize', () => renderSpark());
</script>
</body>
</html>
